
tpl = {

	// Hash of preloaded templates for the app
	templates : {},

	// Recursively pre-load all the templates for the app.
	// This implementation should be changed in a production environment. All
	// the template files should be
	// concatenated in a single file.
	loadTemplates : function(templates, callback) {
		var that = this;

		var names = [ 'layouts/objectlist',
			'layouts/entitylist',
			'layouts/singleobject',
			'layouts/ontologyinformation',
			'layouts/concreteinformation',

			'components/accordiongroup',
			'components/accordionitem',
			'components/backgrid',
			'components/backgrid_actions',

			'components/editor',
			'components/modal',
				
			'components/input_datepicker',
			'components/input_textarea',
			'components/input_text',
			'components/input_image',
			'components/input_tags',
			'components/input_file',
			'components/input_highcharts',
			'components/input_pagination',
			'components/input_select',
			'components/input_locationmap',
			'components/input_datepicker',
			'components/input_checkbox'
				];

		names = names.concat(templates)
		
		var loadTemplate = function(index) {
			var name = names[index];
			var desc = '';
			var subDomain = '';
			
			if (templates.indexOf(name) > -1) {
				$.get(appHost + '/templates/' + name
						+ '.html', function(data) {
					that.templates[name] = data;
					index++;
					if (index < names.length) {
						loadTemplate(index);
					} else {
						callback();
					}
				});
			} else {
				$.get(engulfingBase + '/engulfing-core/templates/' + name
						+ '.html', function(data) {
					that.templates[name] = data;
					index++;
					if (index < names.length) {
						loadTemplate(index);
					} else {
						callback();
					}
				});
			}
			
		};
		
		if (names.length > 0)
			loadTemplate(0);
	},
	
	// Get template by name from hash of preloaded templates
	get : function(name) {
		return this.templates[name];
	}

};
select2ConfigMin = {
	objectName : "",
	allowClear : true,
	placeholder : "Search",
	width : "180px",

	get : function(options, object_name) {
		this.objectName = object_name;

		this.placeholder = object_name.charAt(0).toUpperCase()
				+ object_name.slice(1);

		this.data = options;

		return this;
	},
	initSelection : function(item, callback) {
		var object = $(item).val();

		if (typeof object.models === 'undefined') {
			if (!object.hasOwnProperty('language')) {
				if (typeof object.name === 'undefined') {
					if (object.get('name') == '') {
						var nameById = '';

						for (var i = 0; i < object.enumeration.length; i++) {
							if (object.enumeration[i].id == object.id)
								nameById = object.enumeration[i].text;
						}

						var data = {
							id : object.id,
							text : nameById
						};
					} else {
						var data = {
							id : object.id,
							text : object.get('name')
						};
					}
				} else {
					var data = {
						id : object.id,
						text : object.name
					};
				}

			} else {
				if (typeof object.get('language') === 'undefined') {
					var data = {
						id : object.id,
						text : object.get('name')
					};
				} else {
					var data = {
						id : object.id,
						text : object.get('name') + " ["
								+ object.get('language') + "]"
					};
				}
			}

		} else {
		}

		callback(data);
	}
};
select2Config = {
	objectName : "",
	allowClear : true,
	placeholder : "Search",
	width : "180px",
	minimumInputLength : 2,
	ajax : { // instead of writing the function to execute the request we use
		// Select2's convenient helper
		url : "",
		dataType : 'jsonp',
		quietMillis : 100,
		data : function(term, page) {
			return {
				query : term, // search term
			// page_limit: 10
			};
		},
		results : function(data, page) { // parse the results into the format
			// expected by Select2.
			// since we are using custom formatting functions we do not need to
			// alter remote JSON data
			return {
				results : data
			};
		}
	},

	createSearchChoice : function(term, data) {
		if ($(data).filter(function() {
			return this.text.localeCompare(term) === 0;
		}).length === 0) {
			return {
				id : -99,
				text : term
			};
		}
	},
	initSelection : function(item, callback) {
		var object = $(item).val();

		if (typeof object.models === 'undefined') {
			if (!object.hasOwnProperty('language')) {
				if (typeof object.name === 'undefined') {
					var data = {
						id : object.id,
						text : object.get('name')
					};
				} else {
					var data = {
						id : object.id,
						text : object.name
					};
				}

			} else {
				if (typeof object.get('language') === 'undefined') {
					var data = {
						id : object.id,
						text : object.get('name')
					};
				} else {
					var data = {
						id : object.id,
						text : object.get('name') + " ["
								+ object.get('language') + "]"
					};
				}
			}

		} else {
			var data = [];

			for (var i = 0; i < object.models.length; i++) {
				if (typeof object.models[i].get('language') === 'undefined') {
					data.push({
						id : object.models[i].id,
						text : object.models[i].get('name')
					})
				} else {
					data.push({
						id : object.models[i].id,
						text : object.models[i].get('name') + " ["
								+ object.models[i].get('language') + "]"
					})
				}

			}

		}

		callback(data);
	},
	initConfig : function() {
		delete this.tags;
		this.multiple = false;
		delete this.tokenSeparators;

		return false;
	},
	get : function(url, object_name) {
		this.initConfig();

		this.objectName = object_name;
		this.ajax.url = url;

		this.placeholder = object_name.charAt(0).toUpperCase()
				+ object_name.slice(1);

		return this;
	},
	getTags : function(url, object_name, tags) {
		this.initConfig();

		this.objectName = object_name;
		this.ajax.url = url;

		this.placeholder = object_name.charAt(0).toUpperCase()
				+ object_name.slice(1);

		if (tags) {
			this.tags = tags;
			this.multiple = true;
			this.tokenSeparators = [ ",", " " ];

		}

		return this;
	},

	// formatSelection: movieFormatSelection, // omitted for brevity, see the
	// source of this page
	dropdownCssClass : "bigdrop", // apply css that makes the dropdown taller
	escapeMarkup : function(m) {
		return m;
	} // we do not want to escape markup since we are displaying html in
// results
};
select2QSConfig = {
	objectName : "",
	allowClear : true,
	placeholder : "Search",
	width : "250px",
	minimumInputLength : 3,
	ajax : { // instead of writing the function to execute the request we use
		// Select2's convenient helper
		url : "",
		dataType : 'jsonp',
		quietMillis : 100,
		data : function(term, page) {
			return {
				query : term, // search term
			// page_limit: 10
			};
		},
		results : function(data, page) { // parse the results into the format
			// expected by Select2.
			// since we are using custom formatting functions we do not need to
			// alter remote JSON data
			return {
				results : data
			};
		}
	},

	createSearchChoice : function(term, data) {
		if ($(data).filter(function() {
			return this.text.localeCompare(term) === 0;
		}).length === 0) {
			return {
				id : -99,
				text : term
			};
		}
	},
	//TODO
	initSelection : function(item, callback) {
		var object = $(item).val();

		if (typeof object.models === 'undefined') {
			if (!object.hasOwnProperty('language')) {
				if (typeof object.name === 'undefined') {
					var data = {
						id : object.id,
						text : object.get('name')
					};
				} else {
					var data = {
						id : object.id,
						text : object.name
					};
				}

			} else {
				if (typeof object.get('language') === 'undefined') {
					var data = {
						id : object.id,
						text : object.get('name')
					};
				} else {
					var data = {
						id : object.id,
						text : object.get('name') + " ["
								+ object.get('language') + "]"
					};
				}
			}

		} else {
			var data = [];

			for (var i = 0; i < object.models.length; i++) {
				if (typeof object.models[i].get('language') === 'undefined') {
					data.push({
						id : object.models[i].id,
						text : object.models[i].get('name')
					})
				} else {
					data.push({
						id : object.models[i].id,
						text : object.models[i].get('name') + " ["
								+ object.models[i].get('language') + "]"
					})
				}

			}

		}

		callback(data);
	},
	initConfig : function() {
		delete this.tags;
		this.multiple = false;
		delete this.tokenSeparators;

		return false;
	},
	get : function(url, object_name) {
		this.initConfig();

		this.objectName = object_name;
		this.ajax.url = url;

		this.placeholder = object_name.charAt(0).toUpperCase()
				+ object_name.slice(1);

		return this;
	},
	getTags : function(url, object_name, tags) {
		this.initConfig();

		this.objectName = object_name;
		this.ajax.url = url;

		this.placeholder = object_name.charAt(0).toUpperCase()
				+ object_name.slice(1);

		if (tags) {
			this.tags = tags;
			this.multiple = true;
			this.tokenSeparators = [ ",", " " ];

		}

		return this;
	},

	// formatSelection: movieFormatSelection, // omitted for brevity, see the
	// source of this page
	dropdownCssClass : "bigdrop", // apply css that makes the dropdown taller
	escapeMarkup : function(m) {
		return m;
	} // we do not want to escape markup since we are displaying html in
// results
};
//TODO
function getSubDomain() {
	var subdomain = "";
	
	//window.location.href.indexOf("localhost");
	subdomain = window.location.href;
	
	if (subdomain.indexOf("codegeneration") > -1) {
		var checkSplit = subdomain.split("codegeneration/");
		if (checkSplit[1].length > 0) {
			subdomain += "../";
		}
	} else if (subdomain.indexOf("admin") > -1) {
		var checkSplit = subdomain.split("admin/");
		if (checkSplit[1].length > 0) {
			subdomain += "../";
		}
	} else if (subdomain.indexOf("extraction") > -1) {
		var checkSplit = subdomain.split("extraction/");
		if (checkSplit[1].length > 0) {
			subdomain += "../";
		}
	} else if (subdomain.indexOf("usermanagement") > -1) {
		var checkSplit = subdomain.split("usermanagement/");
		if (checkSplit[1].length > 0) {
			subdomain += "../";
		}
	} else if (subdomain.indexOf("nlp") > -1) {
		var checkSplit = subdomain.split("nlp/");
		if (checkSplit[1].length > 0) {
			subdomain += "../";
		}
	} else if (subdomain.indexOf("km") > -1) {
		var checkSplit = subdomain.split("km/");
		if (checkSplit[1].length > 0) {
			subdomain += "../";
		}
	} else if (subdomain.indexOf("kokos") > -1) {
		var checkSplit = subdomain.split("kokos/");
		if (checkSplit[1].length > 0) {
			subdomain += "../";
		}
	}
	return subdomain;
}
function getUrl() {
    var location = document.createElement("a");
    
    return new URL(location.baseURI);
};
function getLastSegment() {
	var url = getUrl();
	
	var split = url.pathname.split("/");
	
	var lastsegment = "";
	
	if (split.slice(-1)[0] === '') {
		lastsegment = split.slice(-2)[0];
	} else {
		lastsegment = split.slice(-1)[0];
	}
	
	return lastsegment;
}
function getObjectNameByUrl() {
	var lastsegment = getLastSegment();
	
	var singularized = getSingular(lastsegment);
	
	if (singularized) {
		return singularized.charAt(0).toUpperCase() + singularized.slice(1);
	} else {
		return null;
	}
}
function getBaseTemplatesRoot() {
	var root = "";

	return root;
}
function getKeysOfTypeObject(object, withoutRelations = true) {
	var keysOfType = [];
	var keys = Object.keys(object);
	
	for (var i = 0; i < keys.length; i++) {
		if (keys[i][0].toUpperCase() == keys[i][0]) {
			if (withoutRelations) {
				if (keys[i].indexOf("Relation") == -1) {
					keysOfType.push(keys[i]);
				}
			} else {
				keysOfType.push(keys[i]);
			}
			
		}
	}

	return keysOfType;
}
function loadMaps() {
	// Create Google map instance
	var places = new Backbone.GoogleMaps.LocationCollection([ {
		title : "Walker Art Center",
		lat : 44.9796635,
		lng : -93.2748776
	}, {
		title : "Science Museum of Minnesota",
		lat : 44.9429618,
		lng : -93.0981016
	} ]);

	var map = new google.maps.Map($('#TestLocation')[0], {
		center : new google.maps.LatLng(44.9796635, -93.2748776),
		zoom : 12,
		mapTypeId : google.maps.MapTypeId.ROADMAP
	});

	// Render Markers
	var markerCollectionView = new Backbone.GoogleMaps.MarkerCollectionView({
		collection : places,
		map : map
	});
	markerCollectionView.render();
}
/*function get_text_size(text, font) {
    this.element = document.createElement('canvas');
    this.context = this.element.getContext("2d");
    this.context.font = font;
    
    var tsize = {'width':this.context.measureText(text).width, 'height': parseInt(window.getComputedStyle(text).fontSize, 10)};
    
    return tsize;
}*/
function beyondBaseline(text) {
	var pattern = /[g|j|p|q|y]/;
	
	if (text) {
		if(text.match(pattern)) {
		    return true;
		}
	}
	
	
	return false;
}
function hasCapitalLetters(text) {
	if (text == text.toUpperCase()) {
		 return true;
	}
	
	return false;
}
function pageClickAll(pageNumber) {
    $("#page-number-all").text(pageNumber);
}
function get_text_width(txt, font) {
    this.element = document.createElement('canvas');
    this.context = this.element.getContext("2d");
    this.context.font = font;
    return this.context.measureText(txt).width;
}
function getSelectedText() {
	var text = "";
    if (window.getSelection) {
        text = window.getSelection().toString();
    } else if (document.selection && document.selection.type != "Control") {
        text = document.selection.createRange().text;
    }
    
    return text;
}
function getCursorPosition(ctrl) {
	var CaretPos = 0;
    // IE Support
   if (document.selection) {
       ctrl.focus ();
       var Sel = document.selection.createRange ();
       Sel.moveStart ('character', -ctrl.value.length);    
       CaretPos = Sel.text.length;
   }
   // Firefox support
   else if (ctrl.selectionStart || ctrl.selectionStart == '0')
       CaretPos = ctrl.selectionStart;
   return (CaretPos);
}
function getSelectedStart(text) {
	let selectedText = getSelectedText();
	
	return text.indexOf(selectedText);
}
function getSelectedEnd(text) {
	let selectedText = getSelectedText();
	
	return text.indexOf(selectedText) + selectedText.length;
}
function isSelectionRange() {
	selection = getSelectedText();
	
	if (selection.length > 1) return true;
	
	return false;
}
window.Master = Backbone.RelationalModel.extend({
	accessMode : "read",
	detailed : null,
	isWatched : null,
	includeInJSON : true,
	fetch: function (options) {
		if (typeof options !== 'undefined') {
			if (options.detailed) {
	            this.url = this.urlRoot + "/" + this.id + "/detailed";
	        }
		}
		
		
		/*var self = this;
		
		$.when(watchlistPromise).then(function() {
			self.isWatched = user.get('Watchlist').hasItem(this);
		});*/
		
		
		/*
		if (user.get('Watchlist')) {
			for(item in user.get('Watchlist').get('WatchlistItems')) {
				if (this.type == "OntologyClass") {
					
				}
			}
		}*/
		

    	return  Backbone.RelationalModel.prototype.fetch.call(this, options);
    },
    getUrl: function () {
    	var url = '';
    	
    	url += odBase + 'wiki/articles#' + this.get('name');
    	
    	return url;
    },
    
    getRelatedObjects: function () {
    	if (this.isConcrete()) {
    		if (this.type !== "ReleasePublication") {
    			var relations = this.getRelations();
    		}
    	
    		for (var i=0; i < relations.length; i++) {
    			if (!relations[i].related) {
    				//relations[i].related.type = relations[i].options.relatedModel;
    			} else {
    				if (typeof relations[i].related.type === 'undefined') {
        				relations[i].related.type = relations[i].options.relatedModel;
        			}
    			}
    			
    		}

    	} else {
    		var relations = this.get('OntologyClass').get('RelationOntologyClassOntologyClasses');

    		for (var i=0; i < relations.length; i++) {
    			if (relations.models[i].get('OntologyRelationType').get('name') !== "extends") {
    				
    				var related = new Object();
    				related.type = relations.models[i].get('IncomingOntologyClass').get('name');
    				relations.models[i].related = related;
    			}
    		}
    		
    		relations = relations.models;

    	}
    	
    	return relations;
    },
    getEntities: function (groupName) {
    	if (this.isConcrete()) {
    		if (typeof this.get(groupName) === 'undefined') {
    			var entities = this.get(getPlural(groupName)).models;
    		} else {
    			var entities = this.get(groupName).models;
    		}
    	} else {
    		var entities = this.getClassEntities(groupName);
    	}
    	
    	return entities;
    },
    getRelatedModel: function () {
    	return this.instance;
    },
    isEmpty: function () {
    	if (this.isNew()) {
    		if (!this.get('name') && this.type === "OntologyClassEntity") return true;
    		if (this.get('name') === '') return true;
    	}
    	
    	return false;
    },
    isProtected: function (fieldName) {
    	if (fieldName === 'Lexemes' || fieldName === 'Resource' || fieldName === 'isPersistedConcrete') {
    		if (!isAuthorizedField(this.objectName, fieldName, Cookie.get("UserRoleID"))) {
    			return true;
    		}
    	}
    	
    	return false;
    },
    isFieldGroup: function () {
    	var relOCOC_Classes = this.get('RelationOntologyClassOntologyClasses');
    	if (relOCOC_Classes.length > 1) {
			return true;
    	}
    	
    	var relOCOC_Properties = this.get('RelationOntologyClassOntologyProperties');
		if (relOCOC_Properties.length > 1) {
			var nonIdentifiers = 0;
			
			for (var i=0; i < relOCOC_Properties.length; i++) {
				if (relOCOC_Properties.models[i].get('OntologyProperty').get('isIdentifier') == false) {
					nonIdentifiers++;
				}
			}
			
			if (nonIdentifiers > 1) {
				return true;
			}
		} else {
			if (relOCOC_Properties.length == 1) {
				if (relOCOC_Properties.models[0].get('OntologyProperty').get('name') !== "name") {
					return true;
				}
			}
			
		}
		
		return false;
    },
    getModelByGroupName: function(groupName) {
    	if (this.isConcrete()) {
    		model = this.get(groupName);
    	} else {
    		model = this.getOntologyClassEntityByName(getSingular(groupName));
    	}
    	
    	return model;
    },
    isConcrete: function () {
    	if (this.type === "OntologyClassEntity" && this.get('OntologyClass')) {
    		return false;
    	}
    	
    	return true;
    },
    getFieldGroupNameByModel(model) {
    	
    },
    getFieldGroups: function () {
    	var fieldGroups = [];
    	
    	fieldGroups.push({"name" : "Dashboard", "fieldViews" : []} );
    	
    	if (this.isConcrete()) {
    		if (this.__proto__.relations.length > 0) {
    			for (var i=0; i < this.__proto__.relations.length; i++) {
    				if (this.__proto__.relations[i].key === getPlural(this.__proto__.relations[i].relatedModel) && this.__proto__.relations[i].key !== "Lexemes") {
    					var fieldGroupName = this.__proto__.relations[i].relatedModel;
        				
    					fieldGroups.push({"name" : getPlural(fieldGroupName), "fieldViews" : []} );
    				}
    			}
    		} else {
    			
    		}
    	} else {
    		var relations_ococ = this.get('OntologyClass').get('RelationOntologyClassOntologyClasses');
        	
    		for (var i=0; i < relations_ococ.length; i++) {
    			if (relations_ococ.models[i].get('IncomingOntologyClass').isFieldGroup()) {
    				if (relations_ococ.models[i].get('OntologyRelationType').get('name') !== "extends" && relations_ococ.models[i].get('OntologyRelationType').get('name') !== "hasMany") {
        				var relOCOC_Properties = relations_ococ.models[i].get('IncomingOntologyClass').get('RelationOntologyClassOntologyProperties');
        				if (relOCOC_Properties.length > 1 || relOCOC_Properties.models[0].get('OntologyProperty').get('name') !== "name") {
        					var fieldGroupName = relations_ococ.models[i].get('IncomingOntologyClass').get('name');
        					
        					
        					fieldGroups.push({"name" : fieldGroupName, "fieldViews" : []} );
        				}
        			} else if (relations_ococ.models[i].get('OntologyRelationType').get('name') === "hasMany") {
        				var fieldGroupName = relations_ococ.models[i].get('IncomingOntologyClass').get('name');
        				
        				
        				fieldGroups.push({"name" : getPlural(fieldGroupName), "fieldViews" : []} );
        			}
				}
    		}
    	}
    	
    	
		return fieldGroups;
    },
	boundOntologyClass : null,

    bindOntologyClass : function(ontologyClass) {
    	var actions = [];
    	
    	var relsOCOC = ontologyClass.RelationOntologyClassOntologyClasses
    	for (var i = 0; i < relsOCOC.length; i++) {
    		if (relsOCOC[i].OntologyRelationType.name == "hasMany") {
    			if (relsOCOC[i].IncomingOntologyClass.name == "IndicatorObservation") {
    				this.boundOntologyClass = relsOCOC[i].IncomingOntologyClass;
    				//actions.push(this.model.prototype.relations[i].relatedModel);
    			} else if (relsOCOC[i].IncomingOntologyClass.name == "IndexObservation") {
    				this.boundOntologyClass = relsOCOC[i].IncomingOntologyClass;
    			}
    		}
    		
    	}
	},
	watch : function() {
		var watchlist = user.get('Watchlist');
		
		var watchlistitem = WatchlistItem.findOrCreate({
			Watchlist : Watchlist.findOrCreate({id: user.get('Watchlist').id}),
			OntologyClass : OntologyClass.findOrCreate({id: (this.type == "OntologyClass" ? 174 : this.get('OntologyClass').id)}),
			Entity : Entity.findOrCreate({id: (this.type == "OntologyClass" ? this.id : this.id)})
		});
		
		watchlistitemPromise = watchlistitem.save();

		$.when(watchlistitemPromise).then(function() {
			watchlist.get('WatchlistItems').add(watchlistitem);
			
			this.isWatched = true;
		});
	},
	ignore : function() {
		var watchlist = user.get('Watchlist');
		
		for(var i=0; i<watchlist.get('WatchlistItems').length; i++) {
			if (this.type == "OntologyClass") {
				if (watchlist.get('WatchlistItems').models[i].get('Entity')) {
					if ((parseInt(this.id) === parseInt(watchlist.get('WatchlistItems').models[i].get('Entity').id))) {
						watchlist.get('WatchlistItems').models[i].destroy({ dataType: "text", success: function(model, response) {
							watchlist.get('WatchlistItems').remove(model);
							
							this.isWatched = false;
				    	}});
					}
				} else {
					if (parseInt(this.id) === parseInt(watchlist.get('WatchlistItems').models[i].get('entityID'))) {
						watchlist.get('WatchlistItems').models[i].destroy({ dataType: "text", success: function(model, response) {
							watchlist.get('WatchlistItems').remove(model);
							
							this.isWatched = false;
				    	}});
					}
				}
			} else {
				if (watchlist.get('WatchlistItems').models[i].get('OntologyClass')) {
					if (parseInt(this.get('OntologyClass').id) === parseInt(watchlist.get('WatchlistItems').models[i].get('OntologyClass').id) && parseInt(this.id) === parseInt(watchlist.get('WatchlistItems').models[i].get('Entity').id)) {
						watchlist.get('WatchlistItems').models[i].destroy({ dataType: "text", success: function(model, response) {
							watchlist.get('WatchlistItems').remove(model);
							
							this.isWatched = false;
				    	}});
					}
				} else {
					if (parseInt(this.get('OntologyClass').id) === parseInt(watchlist.get('WatchlistItems').models[i].get('ontologyClassID')) && parseInt(this.id) === parseInt(watchlist.get('WatchlistItems').models[i].get('entityID'))) {
						watchlist.get('WatchlistItems').models[i].destroy({ dataType: "text", success: function(model, response) {
							watchlist.get('WatchlistItems').remove(model);
							
							this.isWatched = false;
				    	}});
					}
				}
			}
			
		}
	}
	    
	    
});

window.MasterCollection = Backbone.PageableCollection.extend({
	state : {
		pageSize : 15
	},
	fetch: function (options) {
		if (typeof options !== 'undefined') {
			if (options.OntologyClass) {
				this.OntologyClass = options.OntologyClass;
				
				this.url += "?ontologyClassID=" + this.OntologyClass.id;
			}
			if (options.internalKey) {
				this.url += "&internalKey=" + options.internalKey;
			}
			if (options.relatedOntologyClass) {
				this.url += "&relatedOntologyClassID=" + options.relatedOntologyClass.id;
			}
		}
			
    	return Backbone.PageableCollection.prototype.fetch.call(this, options)
    },
    parseState: function (resp, queryParams, state, options) {
      return {totalRecords: resp.total_count};
    },

    parseRecords: function (resp, options) {
      return resp.items;
    },
    getFieldName : function() {
		return getPlural(this.model.prototype.relations[1].relatedModel);
	},
	hasRelation : function() {
		var modelAttributes = this.getModelAttributes();
		
		for (var i = 0; i < modelAttributes.length; i++) {
			if (modelAttributes[i].indexOf("Relation") !== -1) return modelAttributes[i];
		}
		
		return false;
	},
    getModelAttributes : function() {
    	var attributes = [];
    	
    	for (var i = 0; i < this.model.prototype.relations.length; i++) {
    		attributes.push(this.model.prototype.relations[i].relatedModel);
    	}
    	
		return attributes;
	},
	isConcrete : function() {
		if (this.type === "OntologyClassEntity" && this.get('OntologyClass')) {
    		return false;
    	}
    	
    	return true;
	},
	getString : function() {
		var collectionString = "";
		
		for (var i = 0; i < this.models.length; i++) {
			if (i > 0) {
				collectionString += " " + this.models[i].get('name');
			} else {
				collectionString += this.models[i].get('name');
			}
		}
		
		return collectionString;
	}
});

window.Observation = Master.extend({
	
});
window.ObservationCollection = MasterCollection.extend({
	model : Observation,
	
	getLast : function() {
		return this.models[this.models.length - 1];
	}
});
window.User = Master.extend({
	urlRoot : apiHost + "authentication/users",

	defaults : {
		"id" : null,
		"name" : "",
		"password" : "",
		"eMail" : "",
		"Language" : null,
		"Role" : null,
		"birthDate" : null,
		"Watchlist" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'Language',
		relatedModel : 'Language'
	}, {
		type : Backbone.HasOne,
		key : 'Role',
		relatedModel : 'Role'
	},
	{
		type : Backbone.HasOne,
		key : 'Watchlist',
		relatedModel : 'Watchlist'
	}]
});

window.UserCollection = MasterCollection.extend({
	model : User,
	url : apiHost + "authentication/users"
});

window.Language = Backbone.RelationalModel.extend({
	type : "Language",
	defaults : {
		"id" : null,
		"isoCode" : "",
		"name" : ""
	},
	enumeration : [ {
		id : "0",
		text : "English"
	}, {
		id : "1",
		text : "German"
	} ]
});
window.Owner = User.extend({
	
});
window.Content = Master.extend({
	urlRoot : kmapiHost + "web/contents",
	
	defaults : {
		"ontology" : null,
		"resource" : null
	}
});

window.ContentCollection = MasterCollection.extend({
	urlRoot : kmapiHost + "web/contents",
	model : Content
});
var accessMode;
var user;
if (!Cookie.get("UserRoleID")) {
	$("#referer").val(window.location);
} else {
	var url = $("#signout").attr("href");
	$("#signout").attr("href", url + "?refererURL=" + window.location)
}
var BaseRouter = Backbone.Router.extend({
	objectName : null,

	activeView : null,

	initialize : function() {
		this.route("", "objectList");
		this.route(":id", "singleObject");
		this.route("new", "newObject");
		this.route(":id/entities", "entityList");
		this.route(":id/entities/new", "newEntity");
		this.route(":id/entities/#:entityID", "EntityDetails");
		this.route(":id/entities/import", "entityImport");
		this.route("housekeeping", "housekeeping");
		this.route("usermanagement/users", "objectList");
		
		if (!this.objectName) {
			this.objectName = getObjectNameByUrl();
		}
		
	},
	setActiveView : function(newView) {
		if (this.activeView) {
			this.activeView.clear();
		}

		this.activeView = newView;

		this.activeView.render();
	},
	isLoginFailure : function() {
		if (window.location.href.indexOf('login=failed') !== -1) {
			return true;
		}

		return false;
	},
	isRestricted : function() {
		if (window.location.href.indexOf('login=failed') !== -1) {
			return true;
		}

		return false;
	},
	isAuthorized : function(routeType, id = null) {
		if (!this.objectName) return true;
		
		var roleID = Cookie.get("UserRoleID");
		var userID = Cookie.get("UserID");

		$('#alerts').html('');

		if (objects[this.objectName] !== undefined) {
			if (this.objectName === "User") {
				if (objects[this.objectName][roleID] !== undefined) {
					if(typeof(objects[this.objectName][roleID]) === "boolean"){
						if (objects[this.objectName][roleID]) {
							if (this.objectName === "User") {
								if (id === userID) {
									return true;
								} else {
									if (objects[this.objectName][roleID]) {
										return true;
									} else {
										return false;
									}
								}
							} else {
								return true;
							}
						}
					} else {
						if (objects[this.objectName][roleID][routeType]  !== undefined) {
							return true;
						}
					}
				} else if (objects[this.objectName][99] !== undefined) {
					return true;
				} else {
					if (userID) {
						if (id === userID) {
							return true;
						}
					}
				}
			} else {
				if (objects[this.objectName][roleID] !== undefined) {
					if(typeof(objects[this.objectName][roleID]) === "boolean"){
						if (objects[this.objectName][roleID]) {
							return true;
						}
					} else {
						if (objects[this.objectName][roleID][routeType]  !== undefined) {
							return true;
						}
					}
				} else if (objects[this.objectName][99] !== undefined) {
					return true;
				}
			}
			

		} else {
			return true;
		}
		
		if (appHost) {
			var umHref = appHost + 'usermanagement#';
		} else {
			var umHref = odBase + 'usermanagement/';
		}
		if (this.isLoginFailure()) {
			var alert_msg = '<div class="alert alert-danger">'+
			'<br/>' + 'Login failed.'+
			'<br/><br/>' + 'Please try again with your correct credentials.'+
			'<br/>' + 'If you don´t remember your credentials go to <a href="' + umHref + 'recovery">' + 'Password Recovery'+ '</a>.' +
			'<br/><br/>' + 'In case you´re not registered yet, you might want to <a href="' + umHref + 'register">' + 'Sign Up'+ '</a> here.' +
	    	'</div>';
		} else {
			if (roleID) {
				var alert_msg = '<div class="alert alert-warning">'+
				'<br/>Access not granted.'+
				'<br/><br/>' + 'Please reach out for the <a href="mailto:' + siteAdmin + '">' + 'Site-Administrator' + '</a> to get access for desired resources.' +
				'</div>';
			} else {
				var alert_msg = '<div class="alert alert-warning">'+
				'<br/>Access not granted.'+
				'<br/><br/>' + 'Please login to access this content.' +
				'<br/>' + 'If you don´t remember your credentials go to <a href="' + umHref + 'recovery">' + 'Password Recovery'+ '</a>.' +
				'<br/><br/>' + 'In case you´re not registered yet, you might want to <a href="' + umHref + 'register">' + 'Sign Up'+ '</a> here.' +
		    	'</div>';
			}
		}


		$('#alerts').html(alert_msg);

		return false;
	},
	isWatchedObject : function (object, watchlist) {
		var watchlistItems = watchlist.get('WatchlistItems');

		var item;
		for(var i=0; i<watchlistItems.length; i++) {
			if (object.get('OntologyClass')) {
				if (parseInt(object.get('OntologyClass').id) === parseInt(watchlistItems.models[i].get('ontologyClassID')) && parseInt(object.id) === parseInt(watchlistItems.models[i].get('entityID'))) {
					return true;
				}
			} else if (object.type === "OntologyClass") {
				if (parseInt(object.id) === parseInt(watchlistItems.models[i].get('entityID'))) {
					return true;
				}

			}

		}

		return false;
	},
	objectList : function() {
		if (this.isAuthorized('list')) {
			var self = this;
			
			var objectList = new window[this.objectName + "Collection"]();

			var objectlistView = new ObjectListView({el : $('#content'),
				collection : objectList, objectName : this.objectName});

			self.setActiveView(objectlistView);
		}
	},
	entityList : function() {
		if (this.isAuthorized('list')) {
			var self = this;
			
			var entityList = new window[this.objectName + "Entity" + "Collection"]();

			var entitylistView = new EntityListView({el : $('#content'),
				collection : entityList, objectName : this.objectName});

			self.setActiveView(entitylistView);
		}
	},
	singleObject : function(id) {
		if (this.isAuthorized('single', id)) {
			var object = window[this.objectName].findOrCreate({
				id : id
			});

			if (typeof DataServiceCollection != "undefined") {
				var dataservices = new DataServiceCollection();
				dataservicesPromise = dataservices.fetch();
			}

			accessMode = "read";

			object.type = this.objectName;

			objectPromise = object.fetch();

			var self = this;

			if (Cookie.get("UserID")) {
				user = User.findOrCreate({
					id : Cookie.get("UserID")
				});

				if (!user.get('Watchlist')) {
					/*var watchlist = new Watchlist();

					watchlist.urlRoot = user.urlRoot + "/" + user.id + "/watchlists";

					watchlistPromise = watchlist.fetch();*/
					
					$.when(objectPromise).then(function() {
						var objectView = new SingleObjectView({
							el : $('#content'),
							model : object
						});

						self.setActiveView(objectView);
					});
				} else {
					var watchlist = user.get('Watchlist');
					
					$.when(objectPromise, watchlistPromise).then(function() {
						user.set('Watchlist', watchlist);

						if (self.isWatchedObject(object, watchlist)) {
							object.isWatched = true;
						}
						var objectView = new SingleObjectView({
							el : $('#content'),
							model : object
						});

						self.setActiveView(objectView);
					});
				}

				
			} else {
				$.when(objectPromise).then(function() {
					var objectView = new SingleObjectView({
						el : $('#content'),
						model : object
					});

					self.setActiveView(objectView);

					if (typeof DataServiceCollection != "undefined") {
						var ontologyClass = new OntologyClass();

						ontologyClass.urlRoot = ontologyClass.urlRoot + "?name=" + object.type;

						ontologyClassPromise = ontologyClass.fetch();
					}


					$.when(ontologyClassPromise).then(function() {
						var ontologyInformationView = new OntologyInformationView({
							el : $('#ontologyInformation'),
							model : ontologyClass
						});

						$("#ontologyInformation").append(ontologyInformationView.render().el);
					});


				});
			}
		}
	},
	EntityDetails : function(id, entityID) {
		var entityBase = window[this.objectName].findOrCreate({
			id : id
		});
		entityBase.type = this.objectName;


		entityBasePromise = entityBase.fetch();

		var self = this

		$.when(entityBasePromise).then(function() {
			var object = window[entityBase.type + "Entity"].findOrCreate({
				id : entityID
			});

			object.type = entityBase.type + "Entity";

			object.set(entityBase.type, entityBase);

			accessMode = "read";

			object.fetch({
				success : function() {
					var objectView = new SingleObjectView({
						el : $('#content'),
						model : object
					});

					self.setActiveView(objectView);

					var watchlist = new Watchlist();

					watchlist.urlRoot = self.user.urlRoot + "/" + self.user.id + "/watchlists";

					objectView.user.set('Watchlist', watchlist);

					watchlist.fetch();
				}
			});
		});

	},
	entityImport : function(id) {
		if (isAuthorized(this.objectName, Cookie.get("UserRoleID"))) {
			var object = window[this.objectName].findOrCreate({
				id : id
			});

			accessMode = "read";

			object.type = this.objectName;

			objectPromise = object.fetch();

			var self = this

			$.when(objectPromise).then(function() {
				var entityImportView = new EntityImportView({
					el : $('#content'),
					model : object
				});

				self.setActiveView(entityImportView);
			});
		} else {
			var alert_msg = '<div class="alert alert-warning">'+
			'Authentication Warning'+
			'<br/>' + 'Login Failed'+
			'<br/>' + '<a href="http://localhost.ontologydriven/usermanagement/recovery">' + 'Password Recovery '+ '</a>' +
	    	'</div>';

			$('#alerts').html(alert_msg);
		}
	},
	newObject : function() {
		if (this.isAuthorized('single')) {
			var object = window[this.objectName].findOrCreate({
				id : null
			});

			accessMode = "edit";

			object.type = this.objectName;

			var objectView = new SingleObjectView({
				el : $('#content'),
				model : object
			});

			this.setActiveView(objectView);
		}
	},
	newEntity : function(id) {
		var entityBase = window[this.objectName].findOrCreate({
			id : id
		});
		entityBase.type = this.objectName;

		entityBasePromise = entityBase.fetch();

		var self = this

		$.when(entityBasePromise).then(function() {
			var object = window[entityBase.type + "Entity"].findOrCreate({
				id : null
			});
			object.type = entityBase.type + "Entity";

			object.set(entityBase.type, entityBase);

			accessMode = "edit";

			var objectView = new SingleObjectView({
				el : $('#content'),
				model : object
			});

			self.setActiveView(objectView);
		});
	},

	intro : function() {
		intro_view = new IntroView({
			el : $('#content')
		});

		this.setActiveView(intro_view);
	}
});
var BaseView = Backbone.View.extend({
	initialize : function(options) {
		//this.viewFactory = new ViewFactory();
	},
	events : {
	},
	clear : function() {
		this.stopListening();
		this.undelegateEvents();
		this.$el.empty();

		return this;
	},
	createAdditionalFieldView : function(field) {
		for (var i=0; i < this.model.get('RelationOntologyClassOntologyPropertyEntities').models.length; i++) {
			var rel_entity = this.model.get('RelationOntologyClassOntologyPropertyEntities').models[i];
			if (rel_entity.get('OntologyPropertyEntity').get('OntologyProperty').get('name') === field) {
				var additionalfieldView = new InputLabelView({model: rel_entity.get('OntologyPropertyEntity')});
				additionalfieldView.field = field;

				return additionalfieldView;
			}
		}
	},
	hasFocus : function() {
		if (document.activeElement === this.$el.context) {
			return true;
		} else {
			return false;
		}
	},
	//TODO rethink naming
	focusView : function(item) {
		$("#context").html("");

		var input_id_element = $(item).closest('label');

		var newContextActionButton = new ButtonView({id: "btn_context_dataservice", model: this.model.boundOntologyClass});

		$("#context").append(newContextActionButton.render().el);
	},
	createEntityFieldView : function(field) {
		for (var i=0; i < this.model.get('RelationOntologyClassOntologyPropertyEntities').models.length; i++) {
			var rel_entity = this.model.get('RelationOntologyClassOntologyPropertyEntities').models[i];
			if (rel_entity.get('OntologyPropertyEntity').get('OntologyProperty').get('name') === field) {
				var fieldView = new InputTextView({model: rel_entity.get('OntologyPropertyEntity')});
				fieldView.field = field;

				return fieldView;
			}
		}
		for (var i=0; i < this.model.get('RelationOntologyClassOntologyClassEntities').models.length; i++) {
			var rel_entity = this.model.get('RelationOntologyClassOntologyClassEntities').models[i];
			if (rel_entity.get('IncomingOntologyClassEntity').get('OntologyClass').get('name') === field) {
				var fieldView = new InputSelectView({model: rel_entity});
				fieldView.field = 'IncomingOntologyClassEntity';

				fieldView.labelName = field;

				return fieldView;
			}
		}
	},
	createEntityGroupFieldView : function(field, classEntity) {
		for (var i=0; i < classEntity.get('RelationOntologyClassOntologyPropertyEntities').models.length; i++) {
			var rel_entity = classEntity.get('RelationOntologyClassOntologyPropertyEntities').models[i];
			if (rel_entity.get('OntologyPropertyEntity').get('OntologyProperty').get('name') === field) {
				var fieldView = new InputTextView({model: rel_entity.get('OntologyPropertyEntity')});
				fieldView.field = field;
				fieldView.url = '#' + rel_entity.get('OntologyPropertyEntity').get('name').replaceAll('/', '_');

				return fieldView;
			}
		}
		for (var i=0; i < classEntity.get('RelationOntologyClassOntologyClassEntities').models.length; i++) {
			var rel_entity = classEntity.get('RelationOntologyClassOntologyClassEntities').models[i];
			if (rel_entity.get('IncomingOntologyClassEntity').get('OntologyClass').get('name') === field) {
				var fieldView = new InputSelectView({model: rel_entity});
				fieldView.field = 'IncomingOntologyClassEntity';

				fieldView.labelName = field;

				return fieldView;
			}
		}
	},
	//TODO
	createFieldViewByModel : function(model, field, withCell, reference, compact) {
		var value = model.get(field);
		var value_type = typeof value;
		if (value_type === "object" && value) {
			if (value.models) {
				value.type = getSingular(field);
			} else {
				value.type = field;
			}
		} else {
			if (value === null) {
				if (field[0] === field[0].toUpperCase()) {
					value = new window[field];
					value.type = field;
					model.set(field, value);
				} else {
					value_type = "string";
				}
			}
		}

		var enumeration = null;
		var model_name;
		var model_name_set;
		var object;
		var object_working;


		if (value === null) {
			for (var i=0; i < model.relations.length; i++) {
				if (model.relations[i].key === field) {
					model_name =  model.relations[i].relatedModel;

					object = window[model_name];
					object_working = object.findOrCreate({id: null});

					if (object_working.__proto__.enumeration) {
						model_name_set = model_name;
						value_type = "enumeration";
						enumeration = object_working.__proto__.enumeration;
					} else {
						model_name_set = model_name;
						value = object_working;
						value.type = field;
					}
				}
			}
		} else {
			model_name =  "";

			object = null;
			object_working = null;

			for (var i=0; i < model.relations.length; i++) {
				if (model.relations[i].key === field) {
					model_name =  model.relations[i].relatedModel;

					object = window[model_name];
					object_working = object.findOrCreate({id: null});

					if (object_working.__proto__.enumeration) {
						model_name_set = model_name;
						value_type = "enumeration";
						enumeration = object_working.__proto__.enumeration;
					}
				}
			}
		}

		if (value_type === "string" || value_type === "number") {
			//TODO kick out domainspecific shit
			if (field !== "id" && field.slice(-2) !== "ID" && field !== "DataServices" && field !== "CourseDocument") {
				if (field.slice(-2) == "At" || field.slice(-4) == "Date" || field === "date") {
					var fieldView = new DatePickerView({model: model, field: field});

					return fieldView;
				} else if (field.slice(-10) == "Definition") {
					var fieldView = new InputTextAreaView({model: model, field: field});

					return fieldView;
				} else {
					var fieldView = new InputTextView({model: model, field: field});

					return fieldView;
				}
			}
		} else if (value_type === "boolean") {
			fieldView = new InputCheckBoxView({model: model, field: field});

			return fieldView;
		} else if (value_type === "enumeration") {
			var fieldView = new InputSelectView({model: model, field: field, enumeration: enumeration, withCell: withCell});

			return fieldView;
		} else if (value !== null) {
			if (typeof value === "object") {

				if (value.models) {
					if (field.indexOf("Relation") !== -1) {
						var fieldView = new AccordionGroupView({collection : model.get(field), field: field, baseModel : model});

						return fieldView;
					} else if (field.indexOf("Observations") !== -1) {
						var fieldView = new HighChartsView({model : model, field: field, observationsLimit: 250});

						return fieldView;
					} else {
						var fieldView = new InputTagsView({model: model, field: field});

						return fieldView;
					}

				} else {
					//TODO kick out domainspecific shit
					if (field == "CourseDocument") {
						var fieldView = new FileUploadView({model: model, field: field, withCell: withCell, referencingObject: reference});

						return fieldView;
					} else if (field == "ImpactFunction") {
						var fieldView = new ImpactFunctionView({model: model, field: field, withCell: withCell, withLabel: false});

						return fieldView;
					} else {
						var fieldView = new InputSelectView({model: model, field: field, withCell: withCell});
						//var fieldView = new InputSelectView({model: this.model, tagName: tagName});

						return fieldView;
					}
				}
			}
		}


		return false;
	},
	createFieldView : function(field, withCell) {
		return this.createFieldViewByModel(this.model, field, withCell, false);
	},
	createCompactFieldView : function(field, withCell) {
		return this.createFieldViewByModel(this.model, field, withCell, true);
	},
	assign : function (selector, view) {
	    var selectors;
	    if (_.isObject(selector)) {
	        selectors = selector;
	    }
	    else {
	        selectors = {};
	        selectors[selector] = view;
	    }
	    if (!selectors) return;
	    _.each(selectors, function (view, selector) {
	        view.setElement(this.$(selector)).render();
	    }, this);
	},
	renderTitle : function(title) {
		$(".page-header").attr("style", "display:show");

		if (title) {
			$("#title").html(title);
		} else {
			if (this.options) {
				$("#title").html(getPlural(this.options.objectName));
			} else if (this.model) {
				if (this.model.isConcrete()) {
					$("#title").html(this.model.type + ": " + this.model.get('name'));
				} else {
					$("#title").html(this.model.get('OntologyClass').get('name') + ": " + this.model.getNameProperty().get('name'));
				}

			} else {
				$("#title").html(getSiteMapTitle());
			}
		}
	}
});

var SingleObjectView = BaseView.extend({
	tag : "form",
	id : "field-container",
	
	class : "form-horizontal",
	
	initialize : function() {
		this.template = _.template(tpl.get('layouts/singleobject'));

		this.fieldGroups = [];
		
		if (this.model.type !== "OntologyClass" && this.model.type !== "Ontology") this.fieldGroups = this.model.getFieldGroups();
		
		this.fieldViews = [];
		this.importProcesses = [];
		
		if (this.fieldGroups.length > 0) {
			this.hasFieldGroups = true;
			
			for (var i = 0; i < this.fieldGroups.length; i++) {
				if (this.fieldGroups[i].name === "Dashboard") {
					this.fieldGroups[i].fieldViews = this.getFieldViews();
				} else {
					this.fieldGroups[i].fieldViews = this.getGroupFieldViews(this.fieldGroups[i].name);
				}
			}
			
		} else {
			this.hasFieldGroups = false;
			
			this.fieldViews = this.getFieldViews();
		}
		
		this.contextButtonViews = [];
		
		if (accessMode == "read") {
			this.buttonView = new ButtonView({id: "btn_edit"});
		} else if (accessMode == "edit") {
			this.buttonView = new ButtonView({id: "btn_save"});
		}
		
		SingleObjectView.__super__.initialize.apply(this, arguments);
	},
	events : {
		"click #btn_save" : "saveObject",
		"click #btn_edit" : "editObject",
		"click #btn_addField" : "addField",
		"click #btn_endpoint" : "endpoint",
		"click #btn_entityList" : "entityList",
		"click #btn_endpoint" : "endpoint",
		"click #btn_watch" : "watchObject",
		"click #btn_addToBasket" : "addToBasket",
		"click #btn_ignore" : "ignoreObject",
		"click #btn_entityImport" : "entityImport",
		"click #btn_importProcessing" : "importProcessing"
	},
	addContextButton : function(newContextActionButton) {
		this.contextButtonViews.push(newContextActionButton);
		
	},
	addEntity : function(item) {
    	var url = window.location.href;

    	window.location = url + '/entities/new';
	},
	endpoint : function(item) {
    	var url = window.location.href;

    	window.location = url + '/endpoint';
 	},
 	//singleentity.js leftover
 	addField : function() {
		var ontologyProperty = window["OntologyProperty"].findOrCreate({
			id : null,
			name : null
		});
		var relOCOP = window["RelationOntologyClassOntologyProperty"].findOrCreate({
			id : null,
			OntologyClass : null,
			OntologyProperty : ontologyProperty
		});
		
		var ontologyPropertyEntity = window["OntologyPropertyEntity"].findOrCreate({
			id : null,
			name : null,
			OntologyProperty : ontologyProperty
		});
		var relOCOPEntity = window["RelationOntologyClassOntologyPropertyEntity"].findOrCreate({
			id : null,
			OntologyClassEntity : null,
			OntologyPropertyEntity : ontologyPropertyEntity
		});
		
		this.model.get('RelationOntologyClassOntologyPropertyEntities').models.push(relOCOPEntity);
		
		this.model.get('OntologyClass').get('RelationOntologyClassOntologyProperties').models.push(relOCOP);
		
		var entityFieldName = 'name';
		
		var newfieldView = this.createAdditionalFieldView(entityFieldName);
		
		this.fieldViews.push(newfieldView);
		
		this.render();
		
		return false;
	},
	watchObject : function() {
		if (app.activeView.model.id == this.model.id) {
			this.model.watch();
			
			this.model.isWatched = true;
			
			this.render();
		}
		
		return false;
	},
	addToBasket : function() {
		if (Cookie.get("Basket")) {
			if (app.activeView.model.id == this.model.id) {
				this.model.watch();
				
				this.model.isWatched = true;
				
				this.render();
			}
		} else {
			var basket = new Basket({});
			basket.addPosition(this.model);
			
			Cookie.set("Basket", JSON.stringify(basket));
		}
			
		
		
		return false;
	},
	importProcessing : function(item) {
		var targetID = parseInt(item.currentTarget.attributes.targetid.nodeValue);
		
		this.importProcesses[targetID].start(this.model.id);
		
		return false;
	},
	ignoreObject : function() {
		if (app.activeView.model.id == this.model.id) {
			this.model.ignore();
			
			this.model.isWatched = false;
			
			this.render();
		}
		
		return false;
	},
	editObject : function() {
		accessMode = "edit";
		
		this.render();
		
		return false;
	},
	entityImport : function() {
		var url = window.location.href;

    	window.location = url + '/entities/import';
	},
	entityList : function() {
		var url = window.location.href;

    	window.location = url + '/entities';
	},
	isGroupFieldView : function(fieldName) {
		if (this.fieldGroups === undefined) return false;
		
		for (var i = 0; i < this.fieldGroups.length; i++) {
			if (this.fieldGroups[i].name === fieldName) {
				return true;
			}
		}
		
		return false;
	},
	getFieldViews : function(model) {
		if (model === undefined) {
			model = this.model;
		}
		
		var fieldViews = [];
		
		if (!model) return fieldViews;
		
		//TODO for dashboard/overview fields from separate tabs/fieldgroups need to be prepared condensed or completely avoided
		if (model.isConcrete()) {
			if (model instanceof Backbone.Collection && model.length > 0) {
				if (model.type.substr(0, 8) === "Relation") {
					var subModelView = this.createFieldViewByModel(this.model, getPlural(model.type));
					fieldViews.push(subModelView);
				} else {
					if (relationName = model.hasRelation()) {
						for (var i=0; i < model.length; i++) {
							
							var subModelView = this.createFieldViewByModel(model.models[i], getPlural(relationName));
							fieldViews.push(subModelView);
						}
					} else {
						var subModelView = this.createFieldViewByModel(this.model, getPlural(model.type));
						fieldViews.push(subModelView);
					}
					
				}
			} else if (model instanceof Backbone.Collection && model.length == 0) {
				fieldView = this.createFieldViewByModel(this.model, getPlural(model.type));
				
				fieldViews.push(fieldView);
			} else {
				for(field in model.attributes) {
					if (field !== "id" && field.slice(-2) !== "ID" && !model.isProtected(field)) {
						if (!this.isGroupFieldView(field) && field !== this.model.type) {
							fieldView = this.createFieldViewByModel(model, field);
							
							fieldViews.push(fieldView);
						}
					} else if (field === "name") {
						if (accessMode === "edit") {
							fieldView = this.createFieldViewByModel(model, field);
							
							fieldViews.push(fieldView);
						}
					}
				}
			}
		} else {
			var relations_ococ = model.get('OntologyClass').get('RelationOntologyClassOntologyClasses');
			
			for (var i=0; i < relations_ococ.length; i++) {
				if (relations_ococ.models[i].get('OntologyRelationType').get('name') !== "extends" && relations_ococ.models[i].get('OntologyRelationType').get('name') !== "hasMany") {
					if (!relations_ococ.models[i].get('IncomingOntologyClass').isFieldGroup()) {
						var entityFieldName = relations_ococ.models[i].get('IncomingOntologyClass').get('name');
						
						var hasEntity = false;
						for (var j=0; j < this.model.get('RelationOntologyClassOntologyClassEntities').models.length; j++) {
							if (model.get('RelationOntologyClassOntologyClassEntities').models[j].get('IncomingOntologyClassEntity').get('OntologyClass').get('name') === entityFieldName) {
								hasEntity = true;
							}
						}
						
						if (!hasEntity) {
							var classEntity = window["IncomingOntologyClassEntity"].findOrCreate({
								id : null,
								OntologyClass : relations_ococ.models[i].get('IncomingOntologyClass')
							});
							
							var relClassEntity = window["RelationOntologyClassOntologyClassEntity"].findOrCreate({
								id : null,
								IncomingOntologyClassEntity : classEntity,
								OntologyRelationType : relations_ococ.models[i].get('OntologyRelationType')
							});
							
							this.model.get('RelationOntologyClassOntologyClassEntities').models.push(relClassEntity);
						}
						
						fieldView = this.createEntityFieldView(entityFieldName);
						
						fieldViews.push(fieldView);
					}
				//TODO special concrete information - model not available; root-cause needs to be resolved with clientside abstract2concrete converter
				/*} else if (relations_ococ.models[i].get('OntologyRelationType').get('name') === "hasMany") {
					var entityFieldName = relations_ococ.models[i].get('IncomingOntologyClass').get('name');
					
					if (entityFieldName === "InstrumentObservation") {
						var fieldView = new HighChartsView({model : null, field: "InstrumentObservations", observationsLimit: 250, modelID : this.model.id});
						
						fieldViews.push(fieldView);
					}*/
				}
					
			}
			
			var relations_ocop = this.model.get('OntologyClass').get('RelationOntologyClassOntologyProperties');
			
			for (var i=0; i < relations_ocop.length; i++) {
				var entityFieldName = relations_ocop.models[i].get('OntologyProperty').get('name');
				
				var hasEntity = false;
				for (var j=0; j < this.model.get('RelationOntologyClassOntologyPropertyEntities').models.length; j++) {
					if (this.model.get('RelationOntologyClassOntologyPropertyEntities').models[j].get('OntologyPropertyEntity').get('OntologyProperty').get('name') === entityFieldName) {
						hasEntity = true;
					}
				}
				if (!hasEntity) {
					var propertyEntity = window["OntologyPropertyEntity"].findOrCreate({
						id : null,
						OntologyProperty : relations_ocop.models[i].get('OntologyProperty')
					});
					
					var relPropertyEntity = window["RelationOntologyClassOntologyPropertyEntity"].findOrCreate({
						id : null,
						OntologyPropertyEntity : propertyEntity
					});
					
					this.model.get('RelationOntologyClassOntologyPropertyEntities').models.push(relPropertyEntity);
				}
				
				fieldView = this.createEntityFieldView(entityFieldName);
				
				fieldViews.push(fieldView);
			}
		}
		
		return fieldViews;
	},
	//TODO remove redundant code
	getGroupFieldViews : function (groupName) {
		var relations = this.model.getRelatedObjects();
		
		groupModel = this.model.getModelByGroupName(groupName);
		
		fieldViews = this.getFieldViews(groupModel);
		
		return fieldViews;
	},
	//TODO sync of model does not belong here
	//TODO approach for followup-navigation after save is shitty
	saveObject : function() {
		var input_type;
		
		var attrs = { }, k;
		for(k in this.model.attributes) {
	        attrs[k] = this.model.attributes[k];
	        if (k !== "id") {
	        	input_type = $('#' + k).prop('type');
	        	
	        	if (input_type === "text" || input_type === "password") {
	        		this.model.set(k, $('#' + k).val());
	        	} else {
	        		var objectValue = attrs[k];
	        		
	        		if (objectValue instanceof Backbone.Model) {
	        			if (objectValue.isEmpty()) {
	        				this.model.set(k, null);
	        			}
	        		}
	        	}
	        }
	    }
		
		if (!this.model.isNew()) {
			this.model.url = this.model.urlRoot + "/" + this.model.id;
		}
		
		this.model.save({}, {
		    success: function(model, response){
		    	if(typeof response.error === 'undefined'){
		    		//TODO risky change. not sure why url should be overwritten with collection's
		    		//model.url = model.urlRoot;
			    	
			    	if (model.type.substr(-6, 6) === "Entity") {
			    		var url = window.location.href;
			    		
			    		if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

				    	url = url.split('/');
				    	url.pop();
				    	
				    	var target = url[url.length-2] + "/entities/#" + model.id + "/";
				   	} else {
				   		var url = window.location.href;
			    		
				   		url = url.split('#');
				   		
				   		if (url[1].indexOf(model.type.toLowerCase()) !== -1) {
				   			url_1 = url[1];
				   			
				   			if (url_1.substr(-1) == '/') url_1 = url_1.substr(0, url_1.length - 2);
				   			
				   			url_1 = url_1.split('/');
				   			url_1.pop();
					    	
				   			app.navigate('#' + url_1[0] + "/" + model.id, true);
				   		} else {
				   			app.navigate('#' + model.id, true);
				   		}
				   		
			    	}
		    	} else {
		    		var alert_msg = '<div class="alert alert-danger">'+
		        	response.error.message+
					'<br/>' + response.error.details+
			    	'</div>';
	    			
	    			$('#alerts').html(alert_msg);
		    	}
		    	
		    },
	        error: function(model, response) {
	        	var alert_msg = '<div class="alert alert-danger">'+
	        	response.get('error').message+
				'<br/>' + response.get('error').details+
		    	'</div>';
    			
    			$('#alerts').html(alert_msg);
    			
	            //console.log(model);
	        }/*,
	        wait: true*/
		});
		
		accessMode = "read";
		
		this.render();
		
		return false;
	},
	render : function() {
		var data = {"hasFieldGroups": this.hasFieldGroups};

		this.$el.html(this.template(data));
		
		this.renderTitle();
 		
		if (this.hasFieldGroups) {
			this.renderFieldGroups();			
		} else {
			for (var i = 0; i < this.fieldViews.length; i++) {
				this.$("#field-container").append(this.fieldViews[i].render().el);
				this.fieldViews[i].delegateEvents();
			}
		}
		
		this.renderButtons();
				
		return this;
	},
	renderFieldGroups : function() {
		var fieldGroupTab = '';
		var tabContainerItem = '';
		var fieldGroupTabCaption = '';
		
		tabContainerItem = '<div role="tabpanel" class="tab-pane active" id="dashboard"></div>';
		
		this.$("#tab-container").html(tabContainerItem);
		
		fieldGroupTab = '<li role="presentation" class="active"><a href="#dashboard" id="dashboard-tab" role="tab" data-toggle="tab" aria-controls="dashboard" aria-expanded="true">Overview</a></li>';
		
		this.$("#object-tag-navigation").html(fieldGroupTab);
		for (var j = 0; j< this.fieldGroups[0].fieldViews.length; j++) {
			this.$("#dashboard").append(this.fieldGroups[0].fieldViews[j].render().el);
			this.fieldGroups[0].fieldViews[j].delegateEvents();
		}
		
		
		for (var i=1; i < this.fieldGroups.length; i++) {
			fieldGroupName = this.fieldGroups[i].name;
			if (fieldGroupName.substr(0, 8) === "Relation") {
				fieldGroupTabCaption = fieldGroupName.replace('Relation', '').replace(this.model.type, '');
			} else {
				fieldGroupTabCaption = fieldGroupName;
			}
			
			tabContainerItem = '<div role="tabpanel" class="tab-pane" id="' + fieldGroupTabCaption.toLowerCase() + '"></div>';
			this.$("#tab-container").append(tabContainerItem);
			
			fieldGroupTab = '<li role="presentation" class=""><a href="#' + fieldGroupTabCaption.toLowerCase() + '" id="' + fieldGroupTabCaption.toLowerCase() + '-tab" role="tab" data-toggle="tab" aria-controls="' + fieldGroupTabCaption.toLowerCase() + '" aria-expanded="true">' + fieldGroupTabCaption + '</a></li>';
			this.$("#object-tag-navigation").append(fieldGroupTab);
			
			for (var j = 0; j< this.fieldGroups[i].fieldViews.length; j++) {
				this.$('#' + fieldGroupTabCaption.toLowerCase() ).append(this.fieldGroups[i].fieldViews[j].render().el);
				this.fieldGroups[i].fieldViews[j].delegateEvents();
			}
		}
		
		
		

	},
	renderImportProcessingButton : function (name, importProcessID) {
		var importProcessingButton = new ButtonView({id: "btn_importProcessing", targetID: importProcessID});
		
		importProcessingButton.buttonObjectName = name;
		
		this.$("#sidebar").append('<br /><br /><br /><br />').append(importProcessingButton.render().el);
		importProcessingButton.delegateEvents();
	},
	//TODO renderButtons is ugly
	renderButtons : function() {
		if (Cookie.get("UserID")) {
			if (accessMode == "read") {
				this.buttonView.id = "btn_edit";
			} else if (accessMode == "edit") {
				this.buttonView.id = "btn_save";
			}
			
			this.$("#sidebar").append(this.buttonView.render().el);
			this.buttonView.delegateEvents();
			
			if (this.model.type === "OntologyClass") {
				var newEntityButton = new ButtonView({id: "btn_add_entity"});
				
				this.$("#sidebar").append(newEntityButton.render().el);
				newEntityButton.delegateEvents();
				
				var entitiesImportButton = new ButtonView({id: "btn_entityImport"});
				
				this.$("#sidebar").append('<br /><br /><br /><br />').append(entitiesImportButton.render().el);
				entitiesImportButton.delegateEvents();
				
				var entitiesButton = new ButtonView({id: "btn_entityList"});
				
				this.$("#sidebar").append('<br /><br />').append(entitiesButton.render().el);
				entitiesButton.delegateEvents();
			} else if (this.model.type === "Instrument" || this.model.type === "Indicator") {
				var entitiesImportButton = new ButtonView({id: "btn_entityImport"});
				
				this.$("#sidebar").append('<br /><br /><br /><br />').append(entitiesImportButton.render().el);
				entitiesImportButton.delegateEvents();
			}
			
			if (this.model.isWatched) {
				var ignoreObjectButton = new ButtonView({id: "btn_ignore"});
				
				self.$("#sidebar").append('<br /><br /><br /><br />').append(ignoreObjectButton.render().el);
				ignoreObjectButton.delegateEvents();
			} else {
				var watchObjectButton = new ButtonView({id: "btn_watch"});
				
				self.$("#sidebar").append('<br /><br /><br /><br />').append(watchObjectButton.render().el);
				watchObjectButton.delegateEvents();
			}
			
			if (this.model.type === "DataMartService") {
				var endpointButton = new ButtonView({id: "btn_endpoint"});
				
				this.$("#sidebar").append(endpointButton.render().el);
				endpointButton.delegateEvents();
			}
		} else {
			if (this.model.type == "User") {
				if (accessMode == "edit") {
					this.buttonView.id = "btn_save";
				}
				
				this.$("#sidebar").append(this.buttonView.render().el);
				this.buttonView.delegateEvents();
			}
		}	
		
		if (this.model.isInBasket) {
			var removeFromBasketButton = new ButtonView({id: "btn_removeFromBasket"});
			
			self.$("#sidebar").append('<br /><br /><br /><br />').append(removeFromBasketButton.render().el);
			removeFromBasketButton.delegateEvents();
		} else {
			var addToBasketButton = new ButtonView({id: "btn_addToBasket"});
			
			self.$("#sidebar").append('<br /><br /><br /><br />').append(addToBasketButton.render().el);
			addToBasketButton.delegateEvents();
		}
		
	}
});		
var InputView = BaseView.extend({
	initialize : function(options) {
		if(typeof options  !== 'undefined') {
			this.field = options.field;
			this.labelName = this.field;
			
			this.routeContext = options.routeContext;
			this.valueField = options.valueField;
			this.caption = options.caption;
			
			if(typeof options.withLabel  !== 'undefined') {
				this.withLabel = options.withLabel;
			} else {
				this.withLabel = true;
			}
			
			if (this.field === "name") {
				if (typeof this.model.type === 'undefined') {
					this.model.type = this.model.collection.type;
				}
				this.url = '../' + getPlural(this.model.type).toLowerCase() + '/#' + this.model.id;
			}
			
			
		} else {
			this.withLabel = true;
		}
		
		BaseView.__super__.initialize.apply(this, arguments);
	}
});
		
var ButtonView = Backbone.View.extend({
	tagName : "button",
	className : "btn btn-sm btn-primary pull-right",
	
	buttonObjectName : "",
	
	label : null,
	targetID : null,
	disabled : false,
	
	initialize : function(options) {
		this.targetID = options.targetID;
		
		this.label = options.label;
	},
	events : {
		"click" : "click",
		
	},
	click : function () {
		var id_splitted = this.id.split("_");
		
		if (id_splitted[1] === "context") {
			this.start();
		}
		return id_splitted[1].charAt(0).toUpperCase() + id_splitted[1].slice(1);
	},
	start : function () {
		var service = new Service({
			ontology : "edi",
			resource : "import/data",
			parameterName : "importprocessID",
			parameterValue : this.id
		});
		service.fetch();
	},
	getLabel : function () {
		if (this.label) {
			return this.label;
		} else {
			var id_splitted = this.id.split("_");

			return id_splitted[1].charAt(0).toUpperCase() + id_splitted[1].slice(1) + ' ' + this.buttonObjectName;
		}
	},
	importDataService : function() {
		alert('ass');
	},
	render : function() {
		this.$el.prop("disabled", this.disabled);
		
		this.$el.attr('id', this.id);
		this.$el.attr('targetID', this.targetID);
		
		this.$el.html(this.getLabel());
		
		return this;
	}
});
		
var language = Cookie.get('userLanguage');
if (language == null) language = 'en';
var words = {
		en: {
			name: 'Name',
			//name: 'Ontology Name',
			owned_by: 'Owner',
			isFinal: 'Final',
			isPrivate: 'Private',
			isIdentifier: 'Identifier',
			defaultValue: 'Default Value',
			validationRegularExpression: 'Validation Rule',
			lexeme: 'Lexeme',
			type: 'Type',
			length: 'Length',
			language: 'Language'
		},
		de: {
			isPrivate: 'Geschuetzt',
			language: 'Sprache'
		}
	
};
function isAuthorizedField(objectName, fieldName, roleID) {
	if (roleID === "1") {
		return true;
	}
	/*if (objects[objectName] !== undefined) {
		if (objects[objectName][roleID] !== undefined) {
			return true;
		} else if (objects[objectName][99] !== undefined) {
			return true;
		}
	}*/
	
	return false;
}
function isAuthorized(objectName, roleID) {
	if (objects[objectName] !== undefined) {
		if (objects[objectName][roleID] !== undefined) {
			return true;
		} else if (objects[objectName][99] !== undefined) {
			return true;
		}
	}
	
	return false;
}
function getWordLike(like) {
	if (words[language][like]) return words[language][like];
	if (words.en[like]) return words.en[like];
	
	if (like) {
		if (like.substring(like.indexOf("_")+1) == "name") {
			return like.substring(0, like.indexOf("_"));
		} else {
			like = like.substring(like.indexOf("_")+1);
		}
		if (words[language][like]) return words[language][like];
		if (words.en[like]) return words.en[like];
		
		return like;
	}
	
	return null;
}
function getPlural(singular) {
	if (singular) {
		var trans = getWordLike(singular);
		
		if (trans === "Index") return "Indices";
		
 		return trans.pluralize();
	}
	
	return null;
}
//TODO vomit
function getOntology(objectName) {
	var objName = '';
	objName = objName + objectName;
	objName = objName.toLowerCase();
	var ontologyShortName = "km";
	if (objName == "lexeme" || objName == "word") {
		ontologyShortName = "nlp";
	} else if (objName == "datamart" || objName == "datamartservice") {
		ontologyShortName = "dwh";
	} else if (objName == "dataservice" || objName == "dataprovider" || objName == "datasource" || objName == "importservice") {
		ontologyShortName = "edi";
	} else if (objName == "role" || objName == "user" || objName == "owner") {
		ontologyShortName = "usermanagement";
	} else if (objName == "instrument" || objName == "indicator" || objName == "release" || objName == "impactfunction") {
		ontologyShortName = "";
	} else if (objName == "course" || objName == "module" || objName == "courseevent") {
		ontologyShortName = "lms";
	} else if (objName == "pillowcase" || objName == "pillowfilling") {
		ontologyShortName = "kissenstern";
	} else if (objName == "editor" || objName == "document" || objName == "page") {
		ontologyShortName = "kokos";
	}
	
	return ontologyShortName;
}
function getSingular(plural) {
	if (plural) {
		var trans = getWordLike(plural);
		
		return trans.singularize();
	}
	
	return null;
}
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}
function lowercaseFirstLetter(string) {
    return string.charAt(0).toLowerCase() + string.slice(1);
}
function getURLParameter(name) {
	return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
}
function getSiteMapTitle() {
	for (var i=0; i < sitemap.urls.length; i++) {
		if (location.pathname.indexOf(sitemap.urls[i].url) > -1) {
			return sitemap.urls[i].title;
		}
	}
	
	return null;
}
Date.prototype.format = function() {
	var todaysDate = new Date();
	
	var formattedDate = "";
	
	var yyyy = this.getFullYear().toString();
	var mm = (this.getMonth()+1).toString();
	var dd  = this.getDate().toString();
	
	if(this.toDateString() == todaysDate.toDateString()) {
		var hours  = this.getHours().toString();
		var minutes  = this.getMinutes().toString();
		
		if (hours < 10) hours = "0" + hours;
		
		formattedDate = hours + ":" + minutes;
	} else {
		formattedDate = yyyy + "-" + (mm[1]?mm:"0"+mm[0]) + "-" + (dd[1]?dd:"0"+dd[0]);
	}
	   
	return formattedDate;
};
String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.split(search).join(replacement);
};
window.AccessSummary = Master.extend({
	urlRoot : apiHost + "monitoring/accesssummary",
	
	initialize: function(props){
	    this.urlRoot += props.topic;
	},
	
	defaults : {
		"id" : null,
		"AccessDestinations" : ""
	},
	relations : [ {
		type : Backbone.HasMany,
		key : 'AccessDestinations',
		relatedModel : 'AccessDestination',
		collectionType : 'AccessDestinationCollection'
	} ]
});

window.AccessDestination = Master.extend({
	defaults : {
		"url" : "",
		"title" : "",
		"visits" : ""
	}
});

window.AccessDestinationCollection = MasterCollection.extend({
	model : AccessDestination
});
window.Basket = Master.extend({
	urlRoot : apiHost + "ecommerce/baskets",
	
	defaults : {
		"id" : null,
		"name" : "",
		"Owner" : null,
		"Positions" : null
	},
	relations : [ {
		type : Backbone.HasMany,
		key : 'Positions',
		relatedModel : 'Position',
		collectionType : 'PositionCollection'
	} ],
	addPosition : function(object) {
		var ontologyClass = OntologyClass.findOrCreate({name: object.type});
		
		var position = Position.findOrCreate({
			"amount" : 1,
			"productName" : object.type,
			"productTypeName" : object.get('name')
		});
		
		this.get('Positions').add(position);
	}
});

window.BasketCollection = MasterCollection.extend({
	model : Basket,
	url : apiHost
});

window.Position = Master.extend({
	urlRoot : apiHost + "ecommerce/positions",
	
	defaults : {
		"id" : null,
		"amount" : null,
		"productName" : "",
		"productTypeName" : ""
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'OntologyClass',
		relatedModel : 'OntologyClass'
	},
	{
		type : Backbone.HasOne,
		key : 'Entity',
		relatedModel : 'Entity'
	}],

    parse : function(response){
        return response.Positions; 
    }
});

window.PositionCollection = MasterCollection.extend({
	model : Position,
	url : apiHost
});
window.Corpus = Backbone.RelationalModel.extend({
	urlRoot : apiHost + "nlp/corpora",

	defaults : {
		"id" : null,
		"text" : "",
		"annotation" : ""
	}
});

window.CorpusCollection = Backbone.PageableCollection.extend({
	model : Corpus,
	url : apiHost + "nlp/corpora",
	state : {
		pageSize : 15
	},
	// get the state from Github's search API result
    parseState: function (resp, queryParams, state, options) {
      return {totalRecords: resp.total_count};
    },

    // get the actual records
    parseRecords: function (resp, options) {
      return resp.items;
    }
});
window.DataSummary = Master.extend({
	urlRoot : apiHost + "edi/datasummary",
	
	initialize: function(props){
	    this.urlRoot += props.topic;
	},
	
	defaults : {
		"id" : null,
		"ontologies" : "",
		"ontologyClasses" : "",
		"ontologyProperties" : "",
		"ontologyRelationTypes" : "",
		"facts" : ""
	}
});

window.Document = Master.extend({
	urlRoot : apiHost + "ocr/documents",

	defaults : {
		"id" : null,
		
		"Pages" : null
	}, relations : [ {
		type : Backbone.HasMany,
		key : 'Pages',
		relatedModel : 'Page',
		collectionType : 'PageCollection'
	} ]
});

window.DocumentCollection = MasterCollection.extend({
	model : Document,
	url : apiHost + "ocr/documents"
});
window.Error = Backbone.RelationalModel.extend({
    defaults:{
    	"message":""
    }
});

window.ErrorCollection = Backbone.Collection.extend({
    model:Error,
});
window.Knowledge = Master.extend({
	url : apiHost + "extraction/knowledge",
	defaults : {
		"id": null
	},
	relations : [ {
		type : Backbone.HasMany,
		key : 'fragments',
		relatedModel : 'Fragment',
		// includeInJSON: Backbone.Model.prototype.idAttribute,
		collectionType : 'FragmentCollection'
	} ]
});

window.KnowledgeCollection = MasterCollection.extend({
	model : Knowledge,
	url : apiHost + "extraction/knowledge"
});
window.Lexeme = Master.extend({
	urlRoot : apiHost + "nlp/lexemes",

	defaults : {
		"id" : null,
		"name" : "",
		"Language" : null,
		"Words" : null,
		"OntologyClass" : null,
		"OntologyRelationType" : null,
		"OntologyProperty" : null,
		"OntologyClassEntity" : null,
		"OntologyPropertyEntity" : null
	}, initialize : function() {
	    this.set('Language', Language.findOrCreate({id: Cookie.get('UserLanguageID')}));
	}, relations : [ {
		type : Backbone.HasOne,
		key : 'Language',
		relatedModel : 'Language'
	}, {
		type : Backbone.HasMany,
		key : 'Words',
		relatedModel : 'Word',
		collectionType : 'WordCollection'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyClass',
		relatedModel : 'OntologyClass'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyRelationType',
		relatedModel : 'OntologyRelationType'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyProperty',
		relatedModel : 'OntologyProperty'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyClassEntity',
		relatedModel : 'OntologyClassEntity'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyPropertyEntity',
		relatedModel : 'OntologyPropertyEntity'
	} ]
});

window.LexemeCollection = MasterCollection.extend({
	model : Lexeme,
	url : apiHost + "nlp/lexemes"
});


window.Language = Master.extend({
	type : "Language",
	defaults : {
		"id" : null,
		"isoCode" : "",
		"name" : ""
	},
	enumeration : [ {
		id : 0,
		text : "English"
	}, {
		id : 1,
		text : "German"
	} ]
});
window.News = Master.extend({
	urlRoot : apiHost + "news",
	defaults : {
		"id" : null,
		"title" : "",
		"publishedAt" : "",
		"header" : "",
		"content" : ""
	}
});

window.NewsCollection = MasterCollection.extend({
	model : News,
	url : apiHost + "news",
	
	initialize: function(props){
	    this.url += props.topic;
	}
	
});
window.Ontology = Master.extend({
	urlRoot : kmapiHost + "km/ontologies",
	
	defaults : {
		"id" : null,
		"name" : "",
		"isPrivate" : false,
		"isFinal" : false,
		"Owner" : null,
		"OntologyClasses" : null,
		"OntologyProperties" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'Owner',
		relatedModel : 'Owner'
	}, {
		type : Backbone.HasMany,
		key : 'OntologyClasses',
		relatedModel : 'OntologyClass',
		collectionType : 'OntologyClassCollection'
	}, {
		type : Backbone.HasMany,
		key : 'OntologyProperties',
		relatedModel : 'OntologyProperty',
		collectionType : 'OntologyPropertyCollection'
	} ]
});

window.OntologyCollection = MasterCollection.extend({
	model : Ontology,
	url : kmapiHost + "km/ontologies"
});
window.OntologyClass = Master.extend({
	urlRoot : kmapiHost + "km/ontologyclasses",
	type : "OntologyClass",

	defaults : {
		"id" : null,
		"name" : "",
		"Ontology" : null,
		"Resource" : null,
		"isPersistedConcrete" : null,
		"Lexemes" : null,
		"RelationOntologyClassOntologyClasses" : null,
		"RelationOntologyClassOntologyProperties" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'Ontology',
		relatedModel : 'Ontology'
	}, {
		type : Backbone.HasOne,
		key : 'Resource',
		relatedModel : 'Resource'
	}, {
		type : Backbone.HasMany,
		key : 'Lexemes',
		relatedModel : 'Lexeme',
		collectionType : 'LexemeCollection'
	}, {
		type : Backbone.HasMany,
		key : 'RelationOntologyClassOntologyClasses',
		relatedModel : 'RelationOntologyClassOntologyClass',
		// includeInJSON: Backbone.Model.prototype.idAttribute,
		collectionType : 'RelationOntologyClassOntologyClassCollection'
	}, {
		type : Backbone.HasMany,
		key : 'RelationOntologyClassOntologyProperties',
		relatedModel : 'RelationOntologyClassOntologyProperty',
		// includeInJSON: Backbone.Model.prototype.idAttribute,
		collectionType : 'RelationOntologyClassOntologyPropertyCollection'

	} ],
	getOntologyPropertyByName : function(name) {
		var relOCOC_Properties = this
				.get('RelationOntologyClassOntologyProperties');
		for (var i = 0; i < relOCOC_Properties.length; i++) {
			if (relOCOC_Properties.models[i].get('OntologyProperty')
					.get('name') === name) {
				return relOCOC_Properties.models[i].get('OntologyProperty');
			}
		}

		return false;
	}
});

window.OntologyClassCollection = MasterCollection.extend({
	model : OntologyClass,
	url : kmapiHost + "km/ontologyclasses"
});

window.OutgoingOntologyClass = OntologyClass.extend({

});
window.IncomingOntologyClass = OntologyClass.extend({

});
window.OntologyClassEntity = Master.extend({
	urlRoot : kmapiHost + "km/ontologyclassentities",
	type : "OntologyClassEntity",
	
	defaults : {
		"id" : null,
		"OntologyClass" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'OntologyClass',
		relatedModel : 'OntologyClass'
	}, {
		type : Backbone.HasMany,
		key : 'Lexemes',
		relatedModel : 'Lexeme',
		collectionType : 'LexemeCollection'
	}, {
		type : Backbone.HasMany,
		key : 'RelationOntologyClassOntologyClassEntities',
		relatedModel : 'RelationOntologyClassOntologyClassEntity',
		// includeInJSON: Backbone.Model.prototype.idAttribute,
		collectionType : 'RelationOntologyClassOntologyClassEntityCollection'
	}, {
		type : Backbone.HasMany,
		key : 'RelationOntologyClassOntologyPropertyEntities',
		relatedModel : 'RelationOntologyClassOntologyPropertyEntity',
		// includeInJSON: Backbone.Model.prototype.idAttribute,
		collectionType : 'RelationOntologyClassOntologyPropertyEntityCollection'

	}, {
		type : Backbone.HasOne,
		key : 'Resource',
		relatedModel : 'Resource'
	} ],
    getNameProperty : function() {
    	return this.getPropertyEntityByName('name');
	},
	getOntologyClassEntityByName : function(name) {
		for (var i=0; i < this.get('RelationOntologyClassOntologyClassEntities').models.length; i++) {
			if (this.get('RelationOntologyClassOntologyClassEntities').models[i].get('IncomingOntologyClassEntity').get('OntologyClass').get('name') === name) {
				return this.get('RelationOntologyClassOntologyClassEntities').models[i].get('IncomingOntologyClassEntity');
			}
		}
		
		return false;
	},
    getPropertyEntityByName : function(name) {
		for (var i=0; i < this.get('RelationOntologyClassOntologyPropertyEntities').models.length; i++) {
			if (this.get('RelationOntologyClassOntologyPropertyEntities').models[i].get('OntologyPropertyEntity').get('OntologyProperty').get('name') === name) {
				return this.get('RelationOntologyClassOntologyPropertyEntities').models[i].get('OntologyPropertyEntity');
			}
		}
		
		return false;
 	},
    getClassEntities : function(name) {
    	var classEntities = [];
		
		for (var i=0; i < this.get('RelationOntologyClassOntologyClassEntities').models.length; i++) {
			if (this.get('RelationOntologyClassOntologyClassEntities').models[i].get('IncomingOntologyClassEntity').get('OntologyClass').get('name') === name) {
				classEntities.push(this.get('RelationOntologyClassOntologyClassEntities').models[i].get('IncomingOntologyClassEntity'));
			}
		}
		
		
		for (var i=0; i < this.get('OntologyClass').get('RelationOntologyClassOntologyClasses').models.length; i++) {
			if (this.get('OntologyClass').get('RelationOntologyClassOntologyClasses').models[i].get('IncomingOntologyClass').get('name') === name) {
				var ontologyClass =  this.get('OntologyClass').get('RelationOntologyClassOntologyClasses').models[i].get('IncomingOntologyClass');
				
				
			}
		}
		
		if (classEntities.length == 0) {
			var classEntity = window["IncomingOntologyClassEntity"].findOrCreate({
				id : null,
				OntologyClass : ontologyClass
			});
			
			classEntities.push(classEntity);
		}
		
		
		var relsOCOP = ontologyClass.get('RelationOntologyClassOntologyProperties');
		
		for (var e=0; e < classEntities.length; e++) {
			for (var i=0; i < relsOCOP.models.length; i++) {
				if (!classEntities[e].hasPropertyByName(relsOCOP.models[i].get('OntologyProperty').get('name'))) {
					var relOCOPEntity = window["RelationOntologyClassOntologyPropertyEntity"].findOrCreate({
						id : null,
						OntologyPropertyEntity : new OntologyPropertyEntity({
							id : null,
							name: "",
							OntologyProperty : relsOCOP.models[i].get('OntologyProperty')
						})
					});
					
					classEntities[0].get('RelationOntologyClassOntologyPropertyEntities').push(relOCOPEntity);
				}
			}
		}
		
		return classEntities;
	},
	hasPropertyByName : function(name) {
		var relations = this.get('RelationOntologyClassOntologyPropertyEntities');
		
		for (var i = 0; i < relations.length; i++) {
    		if (relations.models[i].get('OntologyPropertyEntity').get('OntologyProperty').get('name') === name) {
    			return true;
    		}
    	}
		
		return false;
	}
	
});

window.OntologyClassEntityCollection = MasterCollection.extend({
	model : OntologyClassEntity,
	url : kmapiHost + "km/ontologyclassentities"
});


window.OutgoingOntologyClassEntity = OntologyClassEntity.extend({
	type : "OutoingOntologyClassEntity"
	
});
window.IncomingOntologyClassEntity = OntologyClassEntity.extend({
	type : "IncomingOntologyClassEntity"
	
});
window.OntologyEntity = Backbone.Model.extend({
	urlRoot : kmapiHost + "km/Ontologyentitys",

	defaults : {
		"id" : null
	}
});

window.OntologyEntityCollection = Backbone.Collection.extend({
	model : OntologyEntity,
	url : kmapiHost + "km/Ontologyentitys"
});
window.OntologyProperty = Master.extend({
	urlRoot : kmapiHost + "km/ontologyproperties",
	type : "OntologyProperty",
	
	defaults : {
		"id" : null,
		"name" : "",
		"Type" : null,
		"Ontology" : null,
		"Lexemes" : null,
		"isIdentifier" : false,
		"isMandatory" : false,
		"length" : null,
		"validationRegularExpression" : "",
		"defaultValue" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'Ontology',
		relatedModel : 'Ontology'
	},{
		type : Backbone.HasOne,
		key : 'Type',
		relatedModel : 'Type'
	}, {
		type : Backbone.HasMany,
		key : 'Lexemes',
		relatedModel : 'Lexeme',
		collectionType : 'LexemeCollection'
	} ]
});

window.OntologyPropertyCollection = MasterCollection.extend({
	model : OntologyProperty,
	url : kmapiHost + "km/ontologyproperties"
});

window.Type = Backbone.RelationalModel.extend({
	type : "Type",
	defaults : {
		"id" : null,
		"text" : ""
	},
	enumeration : [ {
		id : "0",
		text : "Text"
	}, {
		id : "1",
		text : "Date"
	}, {
		id : "2",
		text : "Number"
	}, {
		id : "3",
		text : "Boolean"
	} ]
});
window.OntologyPropertyEntity = Master.extend({
	urlRoot : kmapiHost + "km/ontologypropertyentities",
	type : "OntologyPropertyEntity",
	
	defaults : {
		"id" : null,
		"name" : ""
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'OntologyProperty',
		relatedModel : 'OntologyProperty'
	}, {
		type : Backbone.HasMany,
		key : 'Lexemes',
		relatedModel : 'Lexeme',
		collectionType : 'LexemeCollection'
	} ]
});

window.OntologyPropertyEntityCollection = MasterCollection.extend({
	model : OntologyPropertyEntity,
	url : kmapiHost + "km/ontologypropertyentities"
});
window.OntologyRelationType = Master.extend({
	urlRoot : kmapiHost + "km/ontologyrelationtypes",
	type : "OntologyRelationType",
	
	defaults : {
		"id" : null,
		"name" : "",
		"Ontology" : null,
		"Lexemes" : null
	},

	relations : [  {
		type : Backbone.HasOne,
		key : 'Ontology',
		relatedModel : 'Ontology'
	}, {
		type : Backbone.HasMany,
		key : 'Lexemes',
		relatedModel : 'Lexeme',
		collectionType : 'LexemeCollection'
	} ]
});

window.OntologyRelationTypeCollection = MasterCollection.extend({
	model : OntologyRelationType,
	url : kmapiHost + "km/ontologyrelationtypes"
});
window.OntologyRelationTypeEntity = Master.extend({
	urlRoot : kmapiHost + "km/ontologyrelationtypeentities",
	type : "OntologyRelationTypeEntity",
	
	defaults : {
		"id" : null,
		"name" : ""
	},

	relations : [  {
		type : Backbone.HasOne,
		key : 'Ontology',
		relatedModel : 'Ontology'
	}, {
		type : Backbone.HasMany,
		key : 'Lexemes',
		relatedModel : 'Lexeme',
		collectionType : 'LexemeCollection'
	} ]
});

window.OntologyRelationTypeEntityCollection = MasterCollection.extend({
	model : OntologyRelationTypeEntity,
	url : kmapiHost + "km/ontologyrelationtypeentities"
});
window.POS = Backbone.RelationalModel.extend({
    url:"http://localhost.ontologydriven/api/nlp/tagpos",
    defaults:{
    	"tagged":""
    }
});

window.POSCollection = Backbone.Collection.extend({
    model:POS,
    url:"http://localhost.ontologydriven/api/nlp/tagpos"
});
window.RelationOntologyClassOntologyClass = Master.extend({
	urlRoot : kmapiHost + "km/relationontologyclassontologyclasses",

	defaults : {
		"id" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'OutgoingOntologyClass',
		relatedModel : 'OutgoingOntologyClass'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyRelationType',
		relatedModel : 'OntologyRelationType'
	}, {
		type : Backbone.HasOne,
		key : 'IncomingOntologyClass',
		relatedModel : 'IncomingOntologyClass'
	} ]

});

window.RelationOntologyClassOntologyClassCollection = MasterCollection
		.extend({
			model : RelationOntologyClassOntologyClass,
			url : kmapiHost + "km/relationontologyclassontologyclasses"
		});
window.RelationOntologyClassOntologyClassEntity = Master.extend({
	urlRoot : kmapiHost + "km/relationontologyclassontologyclassentities",
	type : "RelationOntologyClassOntologyClassEntity",

	defaults : {
		"id" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'OutgoingOntologyClassEntity',
		relatedModel : 'OutgoingOntologyClassEntity'
	}, {
		type : Backbone.HasOne,
		key : 'IncomingOntologyClassEntity',
		relatedModel : 'IncomingOntologyClassEntity'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyRelationType',
		relatedModel : 'OntologyRelationType'
	} ]

});

window.RelationOntologyClassOntologyClassEntityCollection = MasterCollection
		.extend({
			model : RelationOntologyClassOntologyClassEntity,
			url : kmapiHost + "km/relationontologyclassontologyclassentities"
		});
window.RelationOntologyClassOntologyProperty = Master.extend({
	urlRoot : kmapiHost + "km/relationontologyclassontologyproperties",

	defaults : {
		"id" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'OntologyClass',
		relatedModel : 'OntologyClass'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyProperty',
		relatedModel : 'OntologyProperty'
	} ]

});

window.RelationOntologyClassOntologyPropertyCollection = MasterCollection
		.extend({
			model : RelationOntologyClassOntologyProperty,
			url : kmapiHost + "km/relationontologyclassontologyproperties"
		});
window.RelationOntologyClassOntologyPropertyEntity = Master.extend({
	urlRoot : kmapiHost + "km/relationontologyclassontologypropertyentities",
	type : "RelationOntologyClassOntologyPropertyEntity",

	defaults : {
		"id" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'OntologyClassEntity',
		relatedModel : 'OntologyClassEntity'
	}, {
		type : Backbone.HasOne,
		key : 'OntologyPropertyEntity',
		relatedModel : 'OntologyPropertyEntity'
	} ]

});

window.RelationOntologyClassOntologyPropertyEntityCollection = MasterCollection
		.extend({
			model : RelationOntologyClassOntologyPropertyEntity,
			url : kmapiHost + "km/relationontologyclassontologypropertyentities"
		});
window.Role = Master.extend({
	urlRoot : apiHost + "authentication/roles",

	defaults : {
		"id" : null,
		"name" : ""
	},
	enumeration : [ {
		id : "1",
		text : "Administrator"
	}, {
		id : "2",
		text : "Guest"
	}, {
		id : "4",
		text : "Supervisor"
	}, {
		id : "13",
		text : "Editor"
	}  ]
});

window.RoleCollection = MasterCollection.extend({
	model : Role,
	url : apiHost + "authentication/roles"
});
window.Service = Master.extend({
	urlRoot : kmapiHost,

	initialize: function(props){
		var parameterString = $.param( props.parameters );

	    this.urlRoot += props.ontology + "/" + props.resource + "?" + parameterString;
	},
	defaults : {
		"ontology" : null,
		"resource" : null
	}
});

window.ServiceCollection = MasterCollection.extend({
	model : Service,
	url : kmapiHost
});
window.Teaser = Master.extend({
	urlRoot : apiHost + "teaser",
	
	initialize: function(props){
	    this.urlRoot += "/" + props.ontologyName;
	},
	
	defaults : {
		"id" : null
	},
	relations : [  ]
});

window.Watchlist = Master.extend({
	urlRoot : apiHost + "observation/watchlists",
	
	defaults : {
		"id" : null,
		"name" : "",
		"Owner" : null,
		"WatchlistItems" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'Owner',
		relatedModel : 'Watchlist'
	}, {
		type : Backbone.HasMany,
		key : 'WatchlistItems',
		relatedModel : 'WatchlistItem',
		collectionType : 'WatchlistItemCollection'
	} ]
});

window.WatchlistCollection = MasterCollection.extend({
	model : Watchlist,
	url : apiHost
});

window.WatchlistItem = Master.extend({
	urlRoot : apiHost + "observation/watchlistitems",
	
	defaults : {
		"id" : null,
		"OntologyClass" : null,
		"Entity" : null
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'OntologyClass',
		relatedModel : 'OntologyClass'
	},
	{
		type : Backbone.HasOne,
		key : 'Entity',
		relatedModel : 'Entity'
	}]
});

window.WatchlistItemCollection = MasterCollection.extend({
	model : WatchlistItem,
	url : apiHost
});

window.Entity = Master.extend({
	defaults : {
		"id" : null
	}
});
window.Word = Master.extend({
	urlRoot : apiHost + "nlp/words",
	type : "Word",
	
	defaults : {
		"id" : null,
		"name" : "",
		"Language" : null,
		"Lexeme" : null,
		"type" : "",
		"tagBrown" : "",
		"numerus" : "",
		"person" : "",
		"kasus" : "",
		"genus" : "",
		"tempus" : ""
	}, initialize : function() {
	    this.set('Language', Language.findOrCreate({id: Cookie.get('UserLanguageID')}));
	},
	relations : [ {
		type : Backbone.HasOne,
		key : 'Language',
		relatedModel : 'Language'
	}, {
		type : Backbone.HasOne,
		key : 'Lexeme',
		relatedModel : 'Lexeme'
	} ]
});

window.WordCollection = MasterCollection.extend({
	model : Word,
	url : apiHost + "nlp/words"
});
window.AccessSummaryView = Backbone.View.extend({
	tagName : "ul",
	className : "media-list",

	initialize : function(options) {
		this.options = options;
	},
	
	render : function() {
		var titleHTML = '';
		titleHTML += '<h2>' + this.options.objectName + '</h2>';
		
		this.$el.append(titleHTML);
		
		var summary = this.options.summaryData;
		
		summaryPromise = summary.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		$.when(summaryPromise).then(function() {
			self.$("div.spinner-div").remove();

			var newsHTML = '';
			
			_.each(summary.get('AccessDestinations').models, function(object) {
				newsHTML += '<li class="list-group-item">' +
				  '<span class="badge">' + object.get('visits') + '</span>' +
				  '<a href="' + object.get('url') + '">' + object.get('title') + '</a>' +
				  '</li>';
			}, self);
			
			newsHTML += '</ul>';
			
			self.$el.append(newsHTML);
		});
		
		
		return this;
	}
});
var AccordionGroupView = InputView.extend({
	initialize : function(options) {
		AccordionGroupView.__super__.initialize.apply(this, arguments);
		
		this.collection.on('add', this.render, this);
		
		
		this.template = _.template(tpl.get('components/accordiongroup'));
		
		this.accordionItemViews = [];
		
		this.baseModel = options.baseModel;
		
		if (this.collection.length > 0) {
			for(var i=0; i<this.collection.length; i++) {
				this.collection.models[i].type = this.collection.type;
				
				accordionitemView = new AccordionItemView({model : this.collection.models[i], baseModel : this.baseModel});
				
				
				if (accordionitemView) {
					this.accordionItemViews.push(accordionitemView);
				}
			}
		}

     	this.createAddNewButtonView(this.field);
	},
	events : {
		"click #btn_add" : "addnewRelation",
	},
	//TODO does not belong here
	getOutgoingObjectField : function(relationModel) {
		for (field in relationModel.attributes) {
			if (field == "Outgoing" + this.baseModel.type || field == this.baseModel.type) {
				return field;
			}
		}
	},
	addnewRelation : function() {
		var relation_type = getSingular(this.field);
		
		var newRelation = window[relation_type].findOrCreate({
			id : null
		});
		
		//var outgoingObjectField = this.getOutgoingObjectField(newRelation);
		//newRelation.set(outgoingObjectField, this.baseModel);
		
		newRelation.type = relation_type;
		
		this.collection.add(newRelation);
		
		accordionitemView = new AccordionItemView({model : newRelation, baseModel : this.baseModel});
		
		if (accordionitemView) {
			this.accordionItemViews.push(accordionitemView);
		}
		
		this.render();
		
		return false;
	},
	createAddNewButtonView : function(field) {
		this.addnewbuttonView = new ButtonView({className: "btn btn-xs btn-primary pull-right", id: "btn_add"});
	},
	render:function () {
		this.reset;
		
		var data = {"object_name": this.collection.type.toLowerCase(), "field_name": this.collection.getFieldName(), "heading_title": this.baseModel.get('name')};
		
		this.$el.html(this.template(data));
		
		var collectionAttributes = this.collection.getModelAttributes();
		
		if (this.collection.models.length > 0) {
			for (var i = 0; i < collectionAttributes.length; i++) {
				
				if (collectionAttributes[i] !== "id" && collectionAttributes[i] !== this.baseModel.type && collectionAttributes[i].indexOf("Outgoing") == -1 && (this.collection.type.indexOf("Relation") !== -1 && this.collection.type.indexOf(collectionAttributes[i].replace("Entity", "")) !== -1)) {
					this.$("#relation_headers").append('<th>' + collectionAttributes[i] + "</th>");
					
					var collectionModelAttributes = this.collection.models[0].get(collectionAttributes[i]).attributes;
					var keys = getKeysOfTypeObject(collectionModelAttributes);
					if (keys.length == 1) {
						for (var j = 0; j < keys.length; j++) {
							if (typeof this.collection.models[0].get(collectionAttributes[i]).get(keys[j]) === "object" && keys[j].indexOf("Relation") == -1) {
								this.$("#relation_headers").append('<th>' + keys[j] + "</th>");
							}
						}
					}
				}
			}
			this.$("#relation_action").append('<div class="col-md-12" id="panelheader_buttons" style="text-align: right;"></div>');
			
			
			for (var i = 0; i < this.accordionItemViews.length; i++) {
				this.$("#relations").append(this.accordionItemViews[i].render().el);
				this.accordionItemViews[i].delegateEvents();
			}
	    	
			if (accessMode == "edit") {
				this.$("#panelheader_buttons").append(this.addnewbuttonView.render().el);
				this.addnewbuttonView.delegateEvents();
			}
		
		}
		return this;
    }
});
		
var AccordionItemView = InputView.extend({
	tagName : "tr",
	initialize : function(options) {
		AccordionItemView.__super__.initialize.apply(this, arguments);
		
		this.template = _.template(tpl.get('components/accordionitem'));
		
		this.accordionfieldViews = [];

		this.baseModel = options.baseModel

		if (this.model.isConcrete()) {
			for(field in this.model.attributes) {
				//if (field !== "id" && field.indexOf("Outgoing") == -1 && field !== this.baseModel.type &&  (this.model.type.indexOf("Relation") !== -1 && this.model.type.indexOf(field.replace("Entity", "")) !== -1)) {
				if (field !== "id" && field.indexOf("Outgoing") == -1 && field !== this.baseModel.type) {
					fieldView = this.createFieldView(field, true);
					if (fieldView) {
						fieldView.withLabel = false;
						this.accordionfieldViews.push(fieldView);
					}
					
					var collectionModelAttributes = this.model.get(field).attributes;
					var keys = getKeysOfTypeObject(collectionModelAttributes);
					if (keys.length == 1) {
						for (var j = 0; j < keys.length; j++) {
							if (typeof this.model.get(field).get(keys[j]) === "object" && keys[j].indexOf("Relation") == -1) {
								fieldView = this.createFieldViewByModel(this.model.get(field), keys[j], true);
								if (fieldView) {
									fieldView.withLabel = false;
									this.accordionfieldViews.push(fieldView);
								}
							}
						}
					}
					
				}
			}
		} else {
			var relations_ococ = this.model.get('OntologyClass').get('RelationOntologyClassOntologyClasses');
			
			for (var i=0; i < relations_ococ.length; i++) {
				if (relations_ococ.models[i].get('OntologyRelationType').get('name') !== "extends" && relations_ococ.models[i].get('OntologyRelationType').get('name') !== "hasMany") {
					if (!relations_ococ.models[i].get('IncomingOntologyClass').isFieldGroup()) {
						var entityFieldName = relations_ococ.models[i].get('IncomingOntologyClass').get('name');
						
						var hasEntity = false;
						for (var j=0; j < this.model.get('RelationOntologyClassOntologyClassEntities').models.length; j++) {
							if (model.get('RelationOntologyClassOntologyClassEntities').models[j].get('IncomingOntologyClassEntity').get('OntologyClass').get('name') === entityFieldName) {
								hasEntity = true;
							}
						}
						
						if (!hasEntity) {
							var classEntity = window["IncomingOntologyClassEntity"].findOrCreate({
								id : null,
								OntologyClass : relations_ococ.models[i].get('IncomingOntologyClass')
							});
							
							var relClassEntity = window["RelationOntologyClassOntologyClassEntity"].findOrCreate({
								id : null,
								IncomingOntologyClassEntity : classEntity,
								OntologyRelationType : relations_ococ.models[i].get('OntologyRelationType')
							});
							
							this.model.get('RelationOntologyClassOntologyClassEntities').models.push(relClassEntity);
						}
						
						fieldView = this.createEntityFieldView(entityFieldName);
						
						fieldViews.push(fieldView);
					}
				}
			}
		}
		
		
     	this.createDeleteButtonView();
		
	},
	events : {
		"click #btn_delete" : "deleteObject",
	},
	createDeleteButtonView : function() {
		this.deletebuttonView = new ButtonView({className: "btn btn-xs btn-primary pull-right", id: "btn_delete"});
	},
	deleteObject : function() {
		this.model.destroy();
		
		this.remove();
		
		return false;
	},
	render : function() {
		this.$el.empty();
		
		for (var i = 0; i < this.accordionfieldViews.length; i++) {
			this.$el.append($('<td style="padding: 2px; height: 34px;">').append(this.accordionfieldViews[i].render().el));
			this.accordionfieldViews[i].delegateEvents();
		}
		
		if (accessMode == "edit") {
			if(this.$('#panelitem_buttons').length == 0) {
				this.$el.append('<td id="panelitem_buttons" style="width: 80px; text-align: right;"></td>');
			}
			
			this.$("#panelitem_buttons").append(this.deletebuttonView.render().el);
			this.deletebuttonView.delegateEvents();
		} else {
			this.$el.append('<td id="panelitem_buttons" style="width: 80px; text-align: right;"></td>');
		}

		return this;
	}
});
		
window.BackGridTableView = BaseView.extend({
	initialize : function(options) {
		if (options.tplPath) {
			this.template = _.template(tpl.get(options.tplPath));
		} else {
			this.template = _.template(tpl.get('components/backgrid'));
		}
		
		this.OntologyClass = options.OntologyClass;
		
		this.actions = [];
		
		this.columns = [ /*{
			name : "id",
			label : "ID",
			cell : UriCell.extend({
				target : '_self'
			}),
			href : function(rawValue, formattedValue, model) {
				var url = window.location.href;

		    	if (url.indexOf("entities") == -1) {
		    		return "#" + model.id;
		    	} else {
		    		if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

			    	url = url.split('/');
			    	url.pop();
			    	
			    	return url.join('/') + "/entities/#" + model.id;
		    	}
			},
			editable : false
		},*/
		    {
			name : "name",
			label : "Object Name",
			cell : UriCell.extend({
				target : '_self'
			}),
			href : function(rawValue, formattedValue, model) {
				var url = window.location.href;

		    	if (url.indexOf("entities") === -1) {
		    		if (url.indexOf("#") === -1) {
		    			return "#" + model.id;
		    		} else {
		    			url = url.split('#');
		    			
		    			return "#" + url[1] + "/" + model.id;
		    		}
		    	} else {
		    		if (model.collection.OntologyClass.get('isPersistedConcrete')) {
		    			if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

				    	url = url.split('/');
				    	//url.pop();
				    	
				    	return url[0] + '//' + url[1] + '/' + url[2] + '/wiki/articles/#' + model.get('name');
		    		} else {
		    			if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

				    	url = url.split('/');
				    	url.pop();
				    	
				    	return url.join('/') + "/entities/#" + model.id;
		    		}
		    		
		    	}
			},
			editable : false
		} ];
	},
	
	render : function() {
		this.$el.html(this.template());

		
		//TODO!!!!! needs valid backbone-model definition
		//			including defaults. otherwise set-function not working
		//			proper error handling missing
		
		// Set up a grid to use the pageable collection
		var pageableGrid = new Backgrid.Grid({
			columns : this.columns,
			collection : this.collection
		});

		
		// Render the grid
		var $example2 = $("#backgrid-table");
		$example2.append(pageableGrid.render().el)

		// Initialize the paginator
		var paginator = new Backgrid.Extension.Paginator({
		  collection: this.collection
		});

		// Render the paginator
		$example2.after(paginator.render().el);

		// Initialize a client-side filter to filter on the client
		// mode pageable collection's cache.
		/*var filter = new Backgrid.Extension.ClientSideFilter({
		  collection: this.model,
		  fields: ['name']
		});*/

		// Render the filter
		//$example2.before(filter.render().el);

		// Add some space to the filter and move it to the right
		//$(filter.el).css({float: "right", margin: "20px"});

		// Fetch some data
		this.collection.fetch({reset: true, OntologyClass : this.OntologyClass});
		
		
		return this;
	}

});

var ActionsCell = Backgrid.Cell.extend({
	className: "integer-cell renderable",
	
	initialize : function() {
		this.template = _.template(tpl.get('components/backgrid_actions'));

		this.iconViews = [];
		
		for (var i = 0; i < this.__proto__.actions.length; i++) {
			iconView = this.createIconView(this.__proto__.actions[i]);
			if (iconView) {
				this.iconViews.push(iconView);
			}
		}
	},
	events: {
	      "click #btn_delete": "deleteRow",
		  "click #btn_start": "startProcess",
		  "click #btn_generateOntology": "generateOntology",
		  "click #btn_generateWebsite": "generateWebsite",
		  "click #btn_entityList": "entityList",
		  "click #btn_addEntity": "addEntity"
	},
    deleteRow: function (e) {
        e.preventDefault();
        this.model.collection.remove(this.model);
        this.model.destroy();
    },
    startProcess: function (e) {
    	this.model.start();
    },
	addEntity : function(item) {
		var url = window.location.href;

    	/*if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

    	url = url.split('/');
    	url.pop();*/

    	window.location = url + '#' + this.model.id + '/entities/new';
	},
    entityList: function (e) {
    	var url = window.location.href;

    	/*if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

    	url = url.split('/');
    	url.pop();*/

    	//window.location = url.join('/') + '/ontologyclasses/#' + this.model.id + '/entities';
    	window.location = url + '#' + this.model.id + '/entities';
    },
    generateOntology: function (e) {
    	var url = window.location.href;

    	if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

    	url = url.split('/');
    	url.pop();

    	window.location = url.join('/') + '/ontologies/#' + this.model.id;
    },
    generateWebsite: function (e) {
    	var url = window.location.href;

    	if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

    	url = url.split('/');
    	url.pop();

    	window.location = url.join('/') + '/websites/#' + this.model.id;
    },
	createIconView : function(action) {
    	var iconView = new IconView({id: "btn_" + action});
		iconView.action = action;
		
		return iconView;
    },
    render: function () {
		this.$el.html(this.template());

		var data = {"ontologyID": this.model.id};
		
    	for (var i = 0; i < this.iconViews.length; i++) {
    		this.$("#actions").append(this.iconViews[i].render().el);
			this.iconViews[i].delegateEvents();
		}
    	
		return this;
    }
});
var DeleteCell = Backgrid.Cell.extend({
	className: "integer-cell renderable",
	
	initialize : function() {
		this.template = _.template(tpl.get('components/backgrid_delete'));
	},
    events: {
      "click #btn_delete": "deleteRow"
    },
    deleteRow: function (e) {
      e.preventDefault();
      this.model.collection.remove(this.model);
      this.model.destroy();
    },
    render: function () {
      this.$el.html(this.template());
      this.delegateEvents();
      return this;
    }
});
var GenerateCell = Backgrid.Cell.extend({
	className: "integer-cell renderable",
	
	initialize : function() {
		this.template = _.template(tpl.get('components/backgrid_generate'));
	},
    events: {
      "click #btn_generate": "generateOntology"
    },
    generateOntology: function (e) {
    	var url = window.location.href;

    	if (url.substr(-1) == '/') url = url.substr(0, url.length - 2);

    	url = url.split('/');
    	url.pop();

    	window.location = url.join('/') + '/codegenerator/#' + this.model.id;
    	
    	//app.navigate(url.join('/') + '/#' + this.model.id, {trigger: true, replace: true});
    	/*e.preventDefault();
      this.model.collection.remove(this.model);
      this.model.destroy();*/
    },
    render: function () {
    	var data = {"ontologyID": this.model.id};
		
    	this.$el.html(this.template(data));
    	this.delegateEvents();
    	return this;
    }
});
var StartCell = Backgrid.Cell.extend({
	className: "integer-cell renderable",
	
	initialize : function() {
		this.template = _.template(tpl.get('components/backgrid_start'));
	},
    events: {
      "click #btn_start": "startProcess"
    },
    startProcess: function (e) {
    	this.model.start();
    },
    render: function () {
    	var data = {"ontologyID": this.model.id};
		
    	this.$el.html(this.template(data));
    	this.delegateEvents();
    	return this;
    }
});
var UriCell = Backgrid.UriCell.extend({
	render: function () {
        this.$el.empty();
        var rawValue = this.model.get(this.column.get("name"));
        var formattedValue = this.formatter.fromRaw(rawValue, this.model);
        var href = _.isFunction(this.column.get("href")) ? this.column.get('href')(rawValue, formattedValue, this.model) : this.column.get('href');
        this.$el.append($("<a>", {
          tabIndex: -1,
          href: href || rawValue,
          title: this.title || formattedValue,
          target: this.target
        }).text(formattedValue));
        this.delegateEvents();
        return this;
    }
});
var ButtonAddNewView = BaseView.extend({
	initialize : function() {
		this.template = _.template(tpl.get('components/button_addnew'));
	},
	events : {
	},
	/*addnewObject : function(item) {
        app.navigate('new', true);
	},*/
	render : function() {
		this.$el.html(this.template());
		
		return this;
	}
});
		
var ButtonDeleteView = ButtonView.extend({
	initialize : function() {
		this.template = _.template(tpl.get('components/button_delete'));
	},
	events : {
	},
	render : function() {
		this.$el.html(this.template());
		
		return this;
	}
});
		
window.DataSummaryView = Backbone.View.extend({
	tagName : "ul",
	className : "media-list",

	initialize : function(options) {
		this.options = options;
	},
	
	render : function() {
		var titleHTML = '';
		titleHTML += '<h2>' + this.options.objectName + '</h2>';
		
		this.$el.append(titleHTML);
		
		var summary = this.options.summaryData;
		
		summaryPromise = summary.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		$.when(summaryPromise).then(function() {
			self.$("div.spinner-div").remove();

			var newsHTML = '';
			newsHTML += '<ul class="list-group">';
			
			newsHTML += '<li class="list-group-item">' +
				  '<span class="badge">' + summary.get('ontologies') + '</span>' +
				  '<a href="./km/ontologies/">Ontologies</a>' +
				  '</li>';

			newsHTML += '<li class="list-group-item">' +
			  '<span class="badge">' + summary.get('ontologyClasses') + '</span>' +
			  '<a href="./km/ontologyclasses/">Classes</a>' +
			  '</li>';

			newsHTML += '<li class="list-group-item">' +
			  '<span class="badge">' + summary.get('ontologyProperties') + '</span>' +
			  '<a href="./km/ontologyproperties/">Properties</a>' +
			  '</li>';

			newsHTML += '<li class="list-group-item">' +
			  '<span class="badge">' + summary.get('ontologyRelationTypes') + '</span>' +
			  '<a href="./km/ontologyrelationtypes/">Relation Types</a>' +
			  '</li>';

			newsHTML += '</ul>';
			
			self.$el.append(newsHTML);
		});
		
		
		return this;
	}
});

window.WikiDataSummaryView = DataSummaryView.extend({
	render : function() {
		var titleHTML = '';
		titleHTML += '<h2>' + this.options.objectName + '</h2>';
		
		this.$el.append(titleHTML);
		
		var summary = this.options.summaryData;
		
		summaryPromise = summary.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		$.when(summaryPromise).then(function() {
			self.$("div.spinner-div").remove();

			var newsHTML = '';
			newsHTML += '<ul class="list-group">';
			
			for (var k in summary.get('ontologyClassEntities')){
				newsHTML += '<li class="list-group-item">' +
				  '<span class="badge">' + summary.get('ontologyClassEntities')[k]['count'] + '</span>' +
				  '<a href="./km/ontologyclasses/#' + summary.get('ontologyClassEntities')[k]['classID'] + '/entities' + '">' + getPlural(k) + '</a>' +
				  '</li>';
			};
		
			
			newsHTML += '</ul>';
			
			self.$el.append(newsHTML);
		});
		
		return this;
	}
});
var IconView = Backbone.View.extend({
	tagName : "button",
	className : "btn-danger btn-xs",
	
	getGlyphicon : function (action) {
		var glyphicon;
		if (action === "start") {
			glyphicon = "play";
		} else if (action === "generateOntology") {
			glyphicon = "cog";
		} else if (action === "generateWebsite") {
			glyphicon = "cog";
		} else if (action === "delete") {
			glyphicon = "remove";
		} else if (action === "entityList") {
			glyphicon = "list";
		} else if (action === "addEntity") {
			glyphicon = "plus";
		}
		
		return glyphicon;
	},
	render : function() {
		this.$el.attr('id', this.id);
		this.$el.html('<span class="glyphicon glyphicon-' + this.getGlyphicon(this.action) + '"></span>');
		
		this.$el.css({
		     'margin-left'          : "3px",
		     'height'				: "16px",
			 'width'				: "16px",
			 'font-size'			: "8px",
			 'padding-left'			: "3px"
		    });

		return this;
	}
});
		
var InputCheckBoxView = InputView.extend({
	
	initialize : function() {
		InputCheckBoxView.__super__.initialize.apply(this, arguments);
		
		this.template = _.template(tpl.get('components/input_checkbox'));
	},
	events : {
		"click" : "changeValue"
	},
	changeValue : function(item) {
		this.model.set(item.target.id, item.target.checked);
	},
	render : function() {
		var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": this.model.get(this.field)};

		this.$el.html(this.template(data));
		
		return this;
	}
});
		
var DatePickerView = InputView.extend({
	
	initialize : function() {
		DatePickerView.__super__.initialize.apply(this, arguments);

		this.template = _.template(tpl.get('components/input_datepicker'));
	},
	events : {
		"changeDate": "changeValue"
	},
	changeValue : function(item) {
		var date = new Date(item.date);
		
		var day = date.getDate();
		var monthIndex = date.getMonth() +1 ;
		var year = date.getFullYear();

		this.model.set(item.target.id, year + '-' +  monthIndex + '-' + day);
	},
	render : function() {
		var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": this.model.get(this.field)};

		this.$el.html(this.template(data));
		
		this.$("#" + this.field).datepicker({
		    format: "yyyy-mm-dd",
		    autoclose: true
		});
		//this.$("#" + this.field).datepicker('setUTCDate');
		
		return this;
	}
});
		
var FileUploadView = InputView.extend({
	initialize : function(options) {
		this.template = _.template(tpl.get('components/input_file'));
		
		this.labelName = this.field;
		
		this.withLabel = false;
		
		if (options.withCell) {
			this.withCell = options.withCell;
		} else {
			this.withCell = false;
		}
		
		if (options.referencingObject) {
			this.referencingObject = options.referencingObject;
		} else {
			this.referencingObject = false;
		}
	},
	render : function() {
		if (accessMode == "edit") {
			var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value":  this.model.get('name'), "withCell" : this.withCell, "withLabel" : this.withLabel, "labelName" : this.labelName};
			
			this.$el.html(this.template(data));
			
			if (this.model.isConcrete()) {
				if (this.model.isNew()) {
					var uploadUrl = 'http://localhost.ontologydriven/api/edi/uploadfile?ontologyClassName=' + this.field + '&referencingOntologyClassName=' + this.referencingObject.type + '&referencingEntityID=' + this.referencingObject.get('id');
					
					this.$("#input-1").fileinput({
						showUpload:true, 
						previewFileType:'any', 
						uploadUrl: uploadUrl,
						autoReplace: true,
						maxFileCount: 1,
						overwriteInitial: false,
						maxFileSize: 28000
					});
				} else {
					var uploadUrl = 'http://localhost.ontologydriven/api/edi/uploadfile?ontologyClassName=' + this.field + '&entityID=' + this.model.get('id');
					var downloadUrl = 'http://localhost.ontologydriven/api/edi/downloadfile?ontologyClassName=' + this.field + '&entityID=' + this.model.get('id');
					var deleteUrl = 'http://localhost.ontologydriven/api/edi/deletefile?ontologyClassName=' + this.field + '&entityID=' + this.model.get('id');
					
					// custom footer template for the scenario
					// the custom tags are in braces
					var footerTemplate = '<div class="file-thumbnail-footer">\n' +
					'   <div style="margin:5px 0">\n' +
					'       <input class="kv-input kv-new form-control input-sm text-center {TAG_CSS_NEW}" value="{caption}" placeholder="Enter caption...">\n' +
					'       <input class="kv-input kv-init form-control input-sm text-center {TAG_CSS_INIT}" value="{TAG_VALUE}" placeholder="Enter caption...">\n' +
					'   </div>\n' +
					'   {size}\n' +
					'   {actions}\n' +
					'</div>';
					
					this.$("#input-1").fileinput({
					    uploadUrl: uploadUrl,
					    uploadAsync: false,
					    maxFileCount: 1,
					    overwriteInitial: false,
					    layoutTemplates: {footer: footerTemplate, size: '<samp><small>({sizeText})</small></samp>'},
					    previewThumbTags: {
					        '{TAG_VALUE}': '',        // no value
					        '{TAG_CSS_NEW}': '',      // new thumbnail input
					        '{TAG_CSS_INIT}': 'hide'  // hide the initial input
					    },
					    initialPreview: [
					        "<img style='height:160px' src='"+ downloadUrl + "'>"
					    ],
					    initialPreviewConfig: [
					        {caption: this.model.get('name'), size: 327892, width: "120px", url: deleteUrl, key: this.model.get('id')} 
					    ],
					    initialPreviewThumbTags: [
					        {'{TAG_VALUE}': 'City-1.jpg', '{TAG_CSS_NEW}': 'hide', '{TAG_CSS_INIT}': ''}
					    ],
					    uploadExtraData: function() {  // callback example
					        var out = {}, key, i = 0;
					        $('.kv-input:visible').each(function() {
					            $el = $(this);
					            key = $el.hasClass('kv-new') ? 'new_' + i : 'init_' + i;
					            out[key] = $el.val();
					            i++;
					        });
					        return out;
					    }
					});
				}
				
				
			} else {
				this.$("#input-1").fileinput({
					'showUpload':true,
					'previewFileType':'any',
					'uploadUrl': 'http://localhost.ontologydriven/api/edi/uploadfile?ontologyClassID=' + this.model.get('id')
					});
			}
		} else {
			if (this.model) {
				if (this.model.isConcrete()) {
					var downloadUrl = 'http://localhost.ontologydriven/api/edi/downloadfile?ontologyClassName=' + this.field + '&entityID=' + this.model.get('id');
				} else {
					var downloadUrl = 'http://localhost.ontologydriven/api/edi/downloadfile?ontologyClassID=' + this.model.get('id');
				}
				
				var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value":  this.model.get('name'), "withCell" : this.withCell, "withLabel" : this.withLabel, "labelName" : this.labelName, "downloadUrl" : downloadUrl};
			} else  {
				var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": null, "withCell" : this.withCell, "withLabel" : this.withLabel, "labelName" : this.labelName, "downloadUrl" : null};
			}
			
			this.$el.html(this.template(data));
		}
		
		return this;
	}
});
		
var HighChartsView = InputView.extend({
	initialize : function(options) {
		HighChartsView.__super__.initialize.apply(this, arguments);
		
		this.template = _.template(tpl.get('components/input_highcharts'));
		this.withLabel = true;
		this.withCell = false;
		
		if (options.observationsLimit) {
			this.observationsLimit = options.observationsLimit;
		}
		
	},
	events : {
		
	},
	changeValue : function(item) {
	},
	//TODO wtf observation should be assumed to be available. if not. the componentent/view should not be candidate for rendering
	//TODO fetch should not be controlled/triggered out of render. controller should do the fetch and trigger the render depending on availability of inputdata
	render : function() {
		var model_observations = this.model.get(this.field);
		
		if (this.label === undefined) this.label = 'Chart';
		
		if (model_observations !== undefined) {
			var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "label": this.label, "field_value": model_observations.getString(), "withCell" : this.withCell, "withLabel" : this.withLabel, "chart_height" : "250px"};
		} else {
			var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "label": this.label, "field_value": null, "withCell" : this.withCell, "withLabel" : this.withLabel, "chart_height" : "100px"};
		}
		
		this.$el.html(this.template(data));
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="spinner-div" style="vertical-align: top;">' +
	      '<span class="glyphicon glyphicon-refresh spin" style="vertical-align: top;"></span>';
		spinnerHTML += '</div>';
		
		this.$(".form-group").append(spinnerHTML);
		
		if (model_observations === undefined || model_observations.length == 0) {
			model_observations = new ObservationCollection();
			
			if (this.model.isConcrete()) {
				if (this.model.type === "Indicator") {
					model_observations.type = "IndicatorObservations";
					model_observations.url = apiHost + "economics/indicators/" + this.model.id + "/observations";
				} else if (this.model.type === "Instrument") {
					model_observations.type = "InstrumentObservations";
					model_observations.url = apiHost + "economics/instruments/" + this.model.id + "/observations";
				}
			} else {
				if (this.model.get('OntologyClass').get('name') === "Indicator") {
					model_observations.type = "IndicatorObservations";
					model_observations.url = apiHost + "economics/indicators/" + this.model.id + "/observations";
					
				} else if (this.model.get('OntologyClass').get('name') === "Instrument") {
					model_observations.type = "InstrumentObservations";
					model_observations.url = apiHost + "economics/instruments/" + this.model.id + "/observations";
					
				} else {
					model_observations.type = "IndicatorObservations";
					model_observations.url = apiHost + "economics/indicators/" + this.model.id + "/observations";
					
				}
			}
			
			if (this.observationsLimit) {
				model_observations.url += "?limit=" + this.observationsLimit;
			}
			
			model_observations.fetch({
				success : function(model_observations) {
					this.$(".spinner-div").remove();
					
					var series_data = new Array;
					
					for (var i = 0; i < model_observations.models.length; i++) {
						var parts = model_observations.models[i].get('date').split(' ')[0].split('-');
						
						series_data.push([
			                  Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])),
			                  parseFloat(model_observations.models[i].get('close'))]
						);
					}
					
					
					this.$("#" + getPlural(model_observations.type)).highcharts({
				        chart: {
				            zoomType: 'x',
				            height: 200
				        },
				        title: {
				            text: ''
				        },
				        subtitle: {
				            text: document.ontouchstart === undefined ?
				                    '' :
				                    ''
				        },
				        xAxis: {
				            type: 'datetime',
				            minRange: 14 * 24 * 3600000 // fourteen days
				        },
				        yAxis: {
				            title: {
				                text: ''
				            }
				        },
				        legend: {
				            enabled: false
				        },
				        plotOptions: {
				            area: {
				                fillColor: {
				                    linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1},
				                    stops: [
				                        [0, Highcharts.getOptions().colors[0]],
				                        [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
				                    ]
				                },
				                marker: {
				                    radius: 2
				                },
				                lineWidth: 1,
				                states: {
				                    hover: {
				                        lineWidth: 1
				                    }
				                },
				                threshold: null
				            }
				        },
				        series: [{
				            type: 'area',
				            name: '',
				            pointInterval: 24 * 3600 * 1000,
				            pointStart: Date.UTC(1906, 0, 1),
				            data: series_data
				        }]
			        });
				}
			});
		}
		
		return this;
	}
});
		
var InputImageView = InputView.extend({
	initialize : function() {
		this.template = _.template(tpl.get('components/input_image'));
	},
	render : function() {
		var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": this.model.get(this.field), "label_name": this.field, "label_value": this.model.get(this.field)};
		
		
		this.$el.html(this.template(data));
		
		return this;
	}
});
		
var InputLabelView = InputView.extend({
	initialize : function() {
		InputLabelView.__super__.initialize.apply(this, arguments);
		
		this.template = _.template(tpl.get('components/input_label'));
	},
	events : {
		"change" : "changeValue"
	},
	changeValue : function(item) {
		if (typeof this.model.attributes.name === 'undefined') {
			this.model.set(item.target.id, item.target.value);
		} else {
			this.model.set('name', item.target.value);
		}
	},
	render : function() {
		if (typeof this.model.attributes.name === 'undefined') {
			var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": this.model.get(this.field), "label_name": this.field, "label_value": this.model.get(this.field)};
		} else {
			var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": this.model.get('OntologyProperty').get('name'), "label_name": this.field, "label_value": this.model.get('name')};
		}
		
		this.$el.html(this.template(data));
		
		return this;
	}
});
		
var LocationMapView = InputView.extend({
	initialize : function(model, field) {
		this.model = model;
		this.field = field;
		
		this.template = _.template(tpl.get('components/input_locationmap'));
		
		/*this.map = new google.maps.Map(
            this.el,
            this.model.toJSON()
        );*/
        //this.render();
        
		
		
	},
	events : {
		
	},
	changeValue : function(item) {
	},
	render : function() {
		this.$el.html(this.template());

	    var map = L.map(this.$('#map')[0]).setView([55.75, 37.58], 10);
	    L.tileLayer('http://{s}.tile.cloudmade.com/4e5f745e28654b7eb26aab577eed79ee/997/256/{z}/{x}/{y}.png', {
	      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>[…]',
	      maxZoom: 18
	    }).addTo(map);

	    return this;
	}
});
		
var InputPaginationView = InputView.extend({
	initialize : function() {
		InputLabelView.__super__.initialize.apply(this, arguments);
		
		this.template = _.template(tpl.get('components/input_pagination'));
	},
	events : {
		"change" : "changeValue"
	},
	changeValue : function(item) {
		if (typeof this.model.attributes.name === 'undefined') {
			this.model.set(item.target.id, item.target.value);
		} else {
			this.model.set('name', item.target.value);
		}
	},
	render : function() {
		var $paginator = $("#backgrid-paginator");
		$example2.append(pageableGrid.render().el)

		// Initialize the paginator
		var paginator = new Backgrid.Extension.Paginator({
		  collection: this.collection
		});

		// Render the paginator
		$paginator.after(paginator.render().el);
        
		return this;
	}
});
		
//TODO 	get rid of ontology related stuff; try to convert abstract concepts into 
//		concrete ones before passing them to frontend-components
//TODO merge InputSelectView and SelectView
var InputSelectView = InputView.extend({
	
	initialize : function(options) {
		InputSelectView.__super__.initialize.apply(this, arguments);
		
		this.template = _.template(tpl.get('components/input_select'));
		
		if (options.enumeration) {
			this.enumeration = options.enumeration;
		}
		/*this.labelName = this.field;
		
		this.withLabel = true;
		
		if (options.withCell) {
			this.withCell = options.withCell;
		} else {
			this.withCell = false;
		}*/
		
	},
	events : {
		"change" : "changeValue",
		"click" : "focusView"
	},
	changeValue : function(item) {
		var model_name = item.target.id;
		
		if (item.added) {
			if (item.added.name) {
				model_object = window[model_name].findOrCreate({
					id: item.added.id,
					name: item.added.name
				});
			} else {
				model_object = window[model_name].findOrCreate({
					id: item.added.id,
					name: item.added.text
				});
			}
			
			if (model_name === "IncomingOntologyClassEntity") {
				var propertyEntity = window["OntologyPropertyEntity"].findOrCreate({
					id : null,
					name : item.added.text,
					OntologyProperty : this.model.get('IncomingOntologyClassEntity').get('OntologyClass').getOntologyPropertyByName('name')
				});
				
				var relPropertyEntity = window["RelationOntologyClassOntologyPropertyEntity"].findOrCreate({
					id : null,
					OntologyPropertyEntity : propertyEntity
				});
				
				model_object.get('RelationOntologyClassOntologyPropertyEntities').models.push(relPropertyEntity);
				
				model_object.set('OntologyClass', this.model.get('IncomingOntologyClassEntity').get('OntologyClass'));
			}
			
			this.model.set(model_name, model_object);
		} else if (item.removed) {
			model_object = window[model_name].findOrCreate({
				id: item.removed.id
			});
			
			model_object.clear();
		}
		
		return model_object;
	},
	render : function() {
		if (!this.labelName) {
			this.labelName = this.field;
		}
		
		var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": this.model.get(this.field), "withCell" : this.withCell, "withLabel" : this.withLabel, "labelName" : this.labelName};
		
		var model_select = this.model.get(this.field);
		if (!model_select) {
			model_select = new window[this.field];
			model_select.type = this.field;
		}
		if (model_select.type === "IncomingOntologyClassEntity") {
			if (model_select.get('OntologyClass') && (model_select.urlRoot.indexOf("ontologyClassID") === -1)) {
				model_select.urlRoot += "?ontologyClassID=" + model_select.get('OntologyClass').id;
			}
		}
		if (accessMode == "edit") {
			this.$el.html(this.template(data));
			
			var object = this.model.get(this.field);
			
			if (this.options) {
				this.$("#" + model_select.type).select2(select2ConfigMin.get(this.options, model_select.type));
				this.$("#" + model_select.type).select2('val', object);
			} else if (this.enumeration) {
				this.$("#" + model_select.type).select2(select2ConfigMin.get(this.enumeration, model_select.type));
				this.$("#" + model_select.type).select2('val', object);
			} else {
				this.$("#" + model_select.type).select2(select2Config.get(model_select.urlRoot, this.labelName));
				if (this.model) {
					if (model_select.type === "IncomingOntologyClassEntity") {
						var object = model_select.getNameProperty();
						
						if (object) {
							this.$("#" + model_select.type).select2('val', object);
						}
					} else {
						this.$("#" + model_select.type).select2('val', model_select);
					}
				}
			}
		} else if (accessMode == "read") {
			if (this.model) {
				var object_string = "";
				
				if (model_select.type === "OntologyClassEntity" || model_select.type === "IncomingOntologyClassEntity") {
					var object = model_select.getNameProperty();
					
					if (object) {
						if (model_select.id) {
							object_string += '<a href="#' + object.get('name') + '">' + object.get('name') + '</a>';
						} else {
							object_string += object.get('name');
						}
						
						data.field_id = object.get('id');
						data.field_value = object_string;
					} else {
						data.field_id = null;
						data.field_value = "";
					}
					
					
				} else {
					var object = this.model.get(this.field);
					
					if (object) {
						if (object.attributes) {
							if (object.get('name')) {
								if (this.field === "IncomingOntologyClass") {
									object_string += '<a href="../../km/ontologyclasses/#' + object.get('id') + '">' + object.get('name') + '</a>';
								} else {
									ontologyName = getOntology(getSingular(this.field.toString().toLowerCase()));
									if (ontologyName !== "") {
										object_string += '<a href="../../' + ontologyName + '/' + getPlural(this.field).toLowerCase() + '/#' + object.get('id') + '">' + object.get('name') + '</a>';
									} else {
										object_string += '<a href="../../' + getPlural(this.field).toLowerCase() + '/#' + object.get('id') + '">' + object.get('name') + '</a>';
									}
								}
							} else {
								if (object.get('text')) {
									object_string += object.get('text');
								}
							}
							
							data.field_id = object.get('id');
							data.field_value = object_string;
						} else {
							if (object.name) object_string += object.name;
							
							data.field_id = object.id;
							data.field_value = object_string;
						}
					} else {
						data.field_id = null;
						data.field_value = null;
					}
				}
			} else {
				var enumeration = null;
				
				for (var i=0; i < this.model.relations.length; i++) {
					if (this.model.relations[i].key === this.field) {
						model_name =  this.model.relations[i].relatedModel;
						
						object = window[model_name];
						object_working = object.findOrCreate({id: null});
						
						if (object_working.__proto__.enumeration) {
							model_name_set = model_name;
							value_type = "enumeration";
							enumeration = object_working.__proto__.enumeration;
						} else {
							model_name_set = model_name;
							value = object_working;
						}
					}
				}
				
				if (enumeration) {
					var object_string = "";
					object_string += enumeration[this.model.get(scope + "ID")].text;
					
					data.field_value = object_string;
				}
			}
			
			this.$el.html(this.template(data));
		}
		
		
		return this;
	}
});
		
var InputTagsView = InputView.extend({
	initialize : function() {
		InputTagsView.__super__.initialize.apply(this, arguments);
		
		if(typeof this.caption  === 'undefined') {
			this.caption = 'name';
    	}
				
		this.template = _.template(tpl.get('components/input_tags'));
	},
	events : {
		"change" : "changeValue"
	},
    changeValue:function (item) {
    	var object = window[this.model.get(this.field).type];
		
       	if(typeof item.removed  !== 'undefined') {
    		var object_removed = object.findOrCreate({
				id: item.removed.id
			});
    		
    		this.model.get(this.field).remove(object_removed);
    		
    		object_removed.set(this.model.type.toLowerCase() + "ID", null);
    		object_removed.save();
    	} else if(typeof item.added  !== 'undefined') {
    		/*var object_added = object.findOrCreate({
				id: item.added.id
			});*/
    		
    		this.model.get(this.field).push(item.added);
    	}
		
        return this.model;
    },
	render : function() {
		var model_tags = this.model.get(this.field);
		
		var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": model_tags.getString(), "withCell" : this.withCell, "withLabel" : this.withLabel};
		
		
		if (accessMode == "edit") {
			this.$el.html(this.template(data));
			
			this.$("#" + this.field).select2(select2Config.getTags(model_tags.__proto__.url, model_tags.type.toLowerCase(), true, model_tags.models));
	    	
	    	var tags = [];
			
	    	
			for (var i = 0; i < model_tags.models.length; i++) {
				if (typeof model_tags.models[i].attributes.language !== 'undefined') {
					tags.push({
						id : model_tags.models[i].id,
						text : model_tags.models[i].get(this.caption) + " [" + model_tags.models[i].get('Language').get('isoCode') + "]"
					});
				} else {
					tags.push({
						id : model_tags.models[i].id,
						text : model_tags.models[i].get(this.caption)
					});
				}
			}
			
			this.$("#" + this.field).select2('data', tags);
		} else if (accessMode == "read") {
			var tags = [];
			
			var object_string = "";
			//TODO 	needs support for sub-page
			//		currently workaround with explicit specific overwrite
			if(typeof this.routeContext  !== 'undefined') {
				pathRoute = getOntology(getSingular(this.field.toLowerCase())) + '/' + this.routeContext + '/' + getPlural(this.field.toLowerCase()) + '/';
			} else {
				pathRoute = getOntology(getSingular(this.field.toLowerCase())) + '/' + getPlural(this.field.toLowerCase()) + '/#';
			}
			
			for (var i = 0; i < model_tags.models.length; i++) {
				if(typeof this.valueField  !== 'undefined') {
					entityRoute = model_tags.models[i].get(this.valueField);
				} else {
					entityRoute = model_tags.models[i].get('id');
				}
				
				object_string += '<a href="../../' + pathRoute + entityRoute + '">' + model_tags.models[i].get(this.caption) + '</a>';
				
				if (i < model_tags.models.length - 1) {
					object_string += ', ';
				}
			}
			
			
			
			data.field_value = object_string;
			
			
			this.$el.html(this.template(data));
		}
		
		
		
		return this;
	}
});
		
var InputTextView = InputView.extend({
	initialize : function(options) {
		InputTextView.__super__.initialize.apply(this, arguments);
		
		this.template = _.template(tpl.get('components/input_text'));
	},
	events : {
		"change" : "changeValue"
	},
	changeValue : function(item) {
		if (typeof this.model.attributes.name === 'undefined') {
			this.model.set(item.target.id, item.target.value);
		} else {
			this.model.set('name', item.target.value);
		}
	},
	render : function() {
		var field_value = '';
		
		if (typeof this.model.type === 'undefined') {
			this.model.type = 'ReleasePublication';
		}
    		
		if (accessMode == "edit") {
			field_value += this.model.get(this.field);
		} else {
			if (this.model.type === "OntologyPropertyEntity") {
				if (this.url) {
					field_value += '<a href="' + this.url + '">' + this.model.get(this.field) + '</a>';
				} else {
					field_value += this.model.get('name');
				}
			} else {
				if (this.url) {
					field_value += '<a href="' + this.url + '">' + this.model.get(this.field) + '</a>';
				} else {
					field_value += this.model.get(this.field);
				}
			}
		}
		
		
		var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": field_value, "withLabel" : this.withLabel, "labelName" : this.labelName};

		this.$el.html(this.template(data));
		
		return this;
	}
});
		
var InputTextAreaView = InputView.extend({
	initialize : function(options) {
		InputTextAreaView.__super__.initialize.apply(this, arguments);
		
		this.template = _.template(tpl.get('components/input_textarea'));
	},
	events : {
		"change" : "changeValue"
	},
	changeValue : function(item) {
		this.model.set(item.target.id, item.target.value);
	},
	render : function() {
		var data = {"object_name": this.model.type.toLowerCase(), "field_name": this.field, "field_value": this.model.get(this.field)};

		this.$el.html(this.template(data));
		
		return this;
	}
});
		
window.IntroView = BaseView.extend({

    initialize:function () {
		this.template = _.template(tpl.get('layouts/intro'));
    },

    events:{
    },
   
    render: function () {
		var data = {};
		
    	this.$el.html(this.template(data));
    	
    	return this;
    }
});
		
var ModalView = BaseView.extend({
	initialize : function(options) {
		this.template = _.template(tpl.get('components/modal'));
		
		this.parent = options.parent;
		this.bodyText = options.bodyText;
		if (options.confirmationCallback) this.confirmationCallback = options.confirmationCallback.confirmationCallback;
		
	},
	events : {
		"click #btn_confirm" : "confirmQuestion",
	},
	confirmQuestion : function() {
		this.confirmationCallback(this.parent);
		
		this.$('#contextMenu').modal('toggle');
	},
	render : function() {
		var data = {"bodyText": this.bodyText};

		this.$el.html(this.template(data));
		
		return this;
	}
});
		
window.NewsView = Backbone.View.extend({
	tagName : "ul",
	className : "media-list",

	initialize : function(options) {
		this.options = options;
	},
	render : function() {
		var titleHTML = '';
		titleHTML += '<h2>' + this.options.objectName + '</h2>';
		
		this.$el.append(titleHTML);
		
		var newsCollection = this.collection;
		
		newsPromise = newsCollection.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		$.when(newsPromise).then(function() {
			self.$("div.spinner-div").remove();

			
			_.each(newsCollection.models, function(object) {
				$(self.el).append(new NewsItemView({
					model : object
				}).render().el);
			}, self);
		});
		
		
		return this;
	}
});

var NewsItemView = Backbone.View.extend({
	tagName : "li",
	className : "media",

	initialize : function(options) {
		this.options = options;
	},

	render : function() {
		var newsHTML = '';
		
		var datePublishedAt = new Date(this.model.get('publishedAt'));
		
		newsHTML += '<div class="media-body">' +
	      '<h4 class="media-heading">' + this.model.get('title') + ' (' + datePublishedAt.format() + ')' + '</h4>';
		
		if (this.model.get('header')) newsHTML +=  '<p>' + this.model.get('header') + '</p>'
		
		newsHTML += this.model.get('content');
		newsHTML += '</div>';
		
		this.$el.append(newsHTML);
		
		return this;
	}
	
});
window.OntologyTeaserView = Backbone.View.extend({
	//tagName : "ul",
	//className : "media-list",

	initialize : function(options) {
		this.options = options;
	},
	
	render : function() {
		var titleHTML = '';
		titleHTML += '<h2>Economics</h2>';
		
		this.$el.append(titleHTML);
		
		var teaserModel = this.model;
		
		teaserModelPromise = teaserModel.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="economics-spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		//this.$el.append(titleHTML).append(subtitleHTML).append(chartsView.render().$el);
		$.when(teaserModelPromise).then(function() {
			self.$("div.economics-spinner-div").replaceWith(
					'<h4 class="media-heading">' + '<a href="' + teaserModel.getUrl() + '">' + teaserModel.get('name') + '</a>' + ' last updated on ' + new Date(teaserModel.get('lastIndicatorObservationDate')).format() + '</h4>'
					);
			
			var chartsView = new HighChartsView({model : teaserModel, observationsLimit : 60});
			chartsView.withLabel = false;
			chartsView.field = 'IndicatorObservations';
			
			self.$el.append(chartsView.render().$el);
		});
		

		return this;
	}
});

window.FinancialMarketsTeaserView = Backbone.View.extend({
	//tagName : "ul",
	//className : "media-list",

	initialize : function(options) {
		this.options = options;
	},
	
	render : function() {
		var titleHTML = '';
		titleHTML += '<h2>Financial Markets</h2>';
		
		this.$el.append(titleHTML);
		
		var teaserModel = this.model;
		
		financialmarketsTeaserPromise = teaserModel.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		//this.$el.append(titleHTML).append(subtitleHTML).append(chartsView.render().$el);
		$.when(financialmarketsTeaserPromise).then(function() {
			self.$("div.spinner-div").replaceWith(
					'<h4 class="media-heading">' + '<a href="' + teaserModel.getUrl() + '">' + teaserModel.get('name') + '</a>' + ' last updated on ' + new Date(teaserModel.get('lastInstrumentObservationDate')).format() + '</h4>'
					);
			
			var chartsView = new HighChartsView({model : teaserModel, observationsLimit : 250});
			chartsView.withLabel = false;
			chartsView.field = 'InstrumentObservations';
			
			self.$el.append(chartsView.render().$el);
		});
		
		
		return this;
	}
});
//TODO merge InputSelectView and SelectView
window.SelectView = Backbone.View.extend({
	tagName : "select",
	className :  "form-control",
	
	initialize : function(data) {
		this.id = data.id;
		this.model = data.model;
		this.options = data.options;
		this.fieldName = data.fieldName;
		this.caption = data.caption;
		this.onSelectRoute = data.onSelectRoute;
		if (typeof data.valueField !== 'undefined') {
			this.valueField = data.valueField;
		} else {
			this.valueField = 'id';
		}
		
	},

	events : {
		'change' : 'onSelect'
	},
	//TODO get rid of app specifics
	onSelect : function() {
		if (typeof this.onSelectRoute !== 'undefined') {
			if (this.fieldName === 'number') {
				var subRoute = '#documents/' + this.options.models[0].get('documentID') + '/pages/' + this.el.options[this.el.selectedIndex].value;
				var gotoUrl = this.onSelectRoute + subRoute;
				
				Backbone.history.navigate(subRoute, {trigger: true})
			} else if (this.fieldName === 'version') {
				var subRoute = '#documents/' + this.model.get('documentID') + '/pages/' + this.model.get('number') + '/version/' + this.el.options[this.el.selectedIndex].value;
				var gotoUrl = this.onSelectRoute + subRoute;
				
				Backbone.history.navigate(subRoute, {trigger: true})
			}
			
		} else {
			if (this.el.options[this.el.selectedIndex]) {
				var attribute = {};
				attribute[this.fieldName] = this.el.options[this.el.selectedIndex].value;
				
				this.model.set(attribute);
			}

			return this;
		}
			
		
		
	},

	render : function() {
		if (this.options instanceof Backbone.Collection) {
			for (var i = 0; i < this.options.length; i++) {
				if(typeof this.model !== 'undefined') {
					if (this.options.models[i].get(this.valueField) == this.model.get(this.fieldName)) {
						this.$el.append('<option value="'
								+ this.options.models[i].get(this.valueField)
								+ '" selected="true">'
								+ this.caption + ' ' + this.options.models[i].value
								+ '</option>');
					} else {
						this.$el.append('<option value="'
								+ this.options.models[i].get(this.valueField)
								+ '">'
								+ this.caption + ' ' + this.options.models[i].value
								+ '</option>');
					}
				} else {
					this.$el.append('<option value="'
							+ this.options.models[i].get(this.valueField)
							+ '">'
							+ this.caption + ' ' + this.options.models[i].value
							+ '</option>');
				}
			}
		} else if (this.options instanceof Array) {
			//TODO 	get rid of version mgmt related stuff
			//		dependencies:	all non-backbone-collection related select-options (e.g. kokos)
			if (this.fieldName === 'version') {
				for (var i = 0; i < this.options.length; i++) {
					if(typeof this.model !== 'undefined') {
						if (this.options[i].version === this.model.get(this.fieldName)) {
							this.$el.append('<option value="'
									+ this.options[i].version
									+ '" selected="true">'
									+ this.caption + ' ' + this.options[i].version
									+ '</option>');
						} else {
							this.$el.append('<option value="'
									+ this.options[i].version
									+ '">'
									+ this.caption + ' ' + this.options[i].version
									+ '</option>');
						}
					} else {
						this.$el.append('<option value="'
								+ this.options[i].version
								+ '">'
								+ this.caption + ' ' + this.options[i].version
								+ '</option>');
					}
				}
			} else if (this.fieldName === 'zoomFactor') {
				for (var i = 0; i < this.options.length; i++) {
					if(typeof this.model !== 'undefined') {
						if (this.options[i].zoomFactor === editorOptions['zoomFactor']) {
							this.$el.append('<option value="'
									+ this.options[i].zoomFactor
									+ '" selected="true">'
									+ this.caption + ' ' + this.options[i].zoomFactor
									+ '</option>');
						} else {
							this.$el.append('<option value="'
									+ this.options[i].zoomFactor
									+ '">'
									+ this.caption + ' ' + this.options[i].zoomFactor
									+ '</option>');
						}
					} else {
						this.$el.append('<option value="'
								+ this.options[i].version
								+ '">'
								+ this.caption + ' ' + this.options[i].version
								+ '</option>');
					}
				}
			}
		}
		

		//this.onselect();

		return this;
	}
});

var OptionView = Backbone.View.extend({

	tagName : "option",
	render : function() {
		var name = this.model.get("name");
		var id = this.model.get("id");

		if (id == this.options.OntologyrelationtypeID) {
			this.$el.html(name).val(id);
			this.$el.prop('selected', true);
		} else {
			this.$el.html(name).val(id);
		}

		return this;
	}
});
window.ServiceTeaserView = Backbone.View.extend({
	initialize : function(options) {
		this.options = options;
	},
	render : function() {
		var newsHTML = '';
		
		
		return this;
	}
});
window.TableView = Backbone.View
		.extend({
			tagName : 'table',
			className : 'table table-striped table-bordered bootstrap-datatable datatable',
			initialize : function() {
				this.template = _.template(tpl.get('table'));
			},
			render : function(eventName) {
				var title = $('#title').html();
				
				var UserID = Cookie.get('UserID');
				var UserRoleID = Cookie.get('UserRoleID');
				
				if (this.collection.at(0) == null)
					return false;
				
				var data = {"data": this.collection.at(0).toJSON()};
				
				this.$el.html(this.template(data));
				
				
				_.each(this.collection, function(object) {
					$(this.el).append(new TableRowView({
						model : object
					}).render().el);
				}, this);
				
				$('#title').html(getPlural(title));
				
				return this;
			}

		});

window.TableRowView = Backbone.View.extend({

	tagName : "tr",
	
	initialize : function() {
		this.template = _.template(tpl.get('tablerow'));

	},
	events : {
		'click #btn_remove' : 'deleteItem',
		'click #btn_create' : 'newEntity',
		'click #btn_list' : 'showEntities'
	},
	deleteItem : function(item) {
		this.model.destroy({
			success : function(model, response) {
				//this.remove();
				//console.log("Success");
			},
			error : function(model, response) {
				var alert_msg = '<div class="alert alert-danger">'
						+ response.responseText + '</div>';

				$('#alerts').html(alert_msg);
			}
		});

		return false;
	},
	showEntities:function () {
		location.href = 'http://localhost.ontologydriven/km/ontologyclasses/#' + this.model.id + '/entities';
    },
    newEntity:function () {
    	location.href = 'http://localhost.ontologydriven/km/ontologyclasses/#' + this.model.id + '/entities/new';
    },

	render : function() {
		var data = {"data": this.model.toJSON()};

		$(this.el).html(this.template(data));
		
		return this;
	}

});

window.TableCellView = Backbone.View.extend({

	tagName : "td",
	
	render : function() {
		$(this.el).html();
		
		return this;
	}

});
window.TableEntitiesView = Backbone.View
		.extend({

			tagName : 'table',
			className : 'table table-striped table-bordered bootstrap-datatable datatable',
			initialize : function(options) {
				this.options = options;
				_.bindAll(this, 'render');
				
				this.template = _.template(tpl.get('table_entities'));
				this.model.bind("reset", this.render, this);
				var self = this;
				this.model.bind("add", function(object) {
					$(self.el).append(new TableEntitiesRowView({
						model : object
					}).render().el);
				});
			},

			render : function(eventName) {
				if (this.model.at(0) == null)
					return false;
				
				var data = {"data": this.model.at(0).toJSON(), "OntologyClass_id": this.options.OntologyClass_id};

				
				this.$el.html(this.template(data));

				_.each(this.model.models, function(object) {
					$(this.el).append(new TableEntitiesRowView({
						model : object, OntologyClass_id: this.options.OntologyClass_id
					}).render().el);
				}, this);

				return this;
			}

		});

window.TableEntitiesRowView = Backbone.View.extend({

	tagName : "tr",
	
	initialize : function(options) {
		this.options = options;
		_.bindAll(this, 'render');
		
		this.template = _.template(tpl.get('tableentitiesrow'));
		this.model.bind("change", this.render, this);
		//this.model.bind("destroy", this.close, this);
	},
	events : {
		'click #btn_remove' : 'deleteItem'
	},
	deleteItem : function(item) {
		this.model.destroy({
			success : function(model, response) {
				this.remove();
				//console.log("Success");
			},
			error : function(model, response) {
				var alert_msg = '<div class="alert alert-danger">'
						+ response.responseText + '</div>';

				$('#alerts').html(alert_msg);
			}
		});

		return false;
	},
	showEntities:function () {
    	location.href = 'http://Ontologies.localhost/OntologyClasses/#' + this.model.id + '/entities';
    	
	       	/*var ontologyClassentity = new OntologyClassEntity();
			
			var ontologyClassentity_view = new OntologyClassEntityView({el: $('#content'), model: OntologyClassentity});

			OntologyClassentity_view.render();*/

    },
    newEntity:function () {
    	location.href = 'http://Ontologies.localhost/OntologyClasses/#' + this.model.id + '/entities/new';
    	
	       	/*var ontologyClassentity = new OntologyClassEntity();
			
			var ontologyClassentity_view = new OntologyClassEntityView({el: $('#content'), model: OntologyClassentity});

			OntologyClassentity_view.render();*/

    },

	render : function(eventName) {
		var data = {"data": this.model.toJSON(), "OntologyClass_id": this.options.OntologyClass_id};

		$(this.el).html(this.template(data));
		return this;
	}

});
window.TrackerView = Backbone.View.extend({
	//tagName : "ul",
	//className : "media-list",

	initialize : function(options) {
		this.collection = options.collection;
	},
	events : {
		"mouseover .list-group-item" : "hooverArea"
	},
	//TODO doublicate implemenation in string.js - consolidate
	hooverArea : function(item) {
		if (typeof editorOptions !== 'undefined') {
			if (editorOptions['imageAvailable']) {
				$(".list-group-item").hover(function() {
				    $(this).css('cursor','pointer');
				}, function() {
				    $(this).css('cursor','auto');
				});
				
				let xCoor = +item.target.getAttribute('hpos');
				let yCoor = +item.target.getAttribute('vpos');
				
				let hooverTop = 0 + (+yCoor * editorOptions['zoomFactor']);
				let hooverLeft = 0 + (+xCoor * editorOptions['zoomFactor']);
				
				$("#hooverCraft").css({
					'position' : 'absolute',	
					'width' : +item.target.getAttribute('width') * editorOptions['zoomFactor'] + 'px',
					'height' : +item.target.getAttribute('height') * editorOptions['zoomFactor'] + 'px',
					'left' : hooverLeft + 'px',
					'top' : hooverTop + 'px',
					'backgroundColor' : 'rgba(255, 0, 0, 0.2)'
				});
			}
		}
	},
	//TODO implementing as filter would be nicer
	renderAllChangesHighlighting : function(changes) {
		/*_.each(changes, function(object) {
			$("span[hpos=" + object.get('HPOS') + "][vpos=" + object.get('VPOS') + "]:contains(" + object.get('after') + ")").css({
				'border' : 'red solid 1px'
			});
			
		}, this);*/
		if (editorOptions['facsimileVisibility'])	{
			_.each(changes, function(object) {
				let hooverTop = 0 + (+object.get('VPOS') * editorOptions['zoomFactor']);
				let hooverLeft = 0 + (+object.get('HPOS') * editorOptions['zoomFactor']);
				
				let width = 0 + (+object.get('WIDTH') * editorOptions['zoomFactor']);
				let height = 0 + (+object.get('HEIGHT') * editorOptions['zoomFactor']);
				
				
				$("#scanImage").append('<div id="change_' + object.get('HPOS') + '_' + object.get('VPOS') + '" style="position: absolute; ' + 'left: ' + hooverLeft + 'px' + '; top: ' +  + hooverTop + 'px' + '; width: ' + width + 'px' + '; height: ' + height + 'px' + '; border: red solid 1px; ' + '"></div>');
			}, this);
		}
	},
	//TODO get rid of app specific stuff
	renderChanges : function(scope) {
		var titleHTML = '';
		titleHTML += '<h2>Changes</h2>';
		
		this.$el.append(titleHTML);
		
		var differenceCollection = this.collection;
		
		differenceCollectionPromise = differenceCollection.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="track-changes-spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		$.when(differenceCollectionPromise).then(function() {
			self.$("div.track-changes-spinner-div").remove();

			var changesHTML = '';
			changesHTML += '<ul class="list-group">';
			
			_.each(differenceCollection.models, function(object) {
				if (scope == 'page') {
					changesHTML += '<li class="list-group-item" HPOS="' + object.get('HPOS') + '" VPOS="' + object.get('VPOS') + '" WIDTH="' + object.get('WIDTH') + '" HEIGHT="' + object.get('HEIGHT') + '">' +
					object.get('Page').updatedByUser.name + 
				  	' changed ' + object.get('before') + ' to ' + object.get('after') +
				  	' at ' + object.get('Page').updatedAt + ' (version: ' + object.get('Page').version + ')' +
				  '</li>';
				} else {
					changesHTML += '<li class="list-group-item">' +
					object.get('Page').updatedByUser.name + 
				  	' changed ' + object.get('before') + ' to ' + object.get('after') +
				  	' on <a href="./editor/#documents/' + object.get('Page').documentID + '/pages/' +  object.get('Page').number + '">page <i>' +object.get('Page').number + ' of document</i></a>' +
				  	' at ' + object.get('Page').updatedAt +
				  '</li>';
				}
				
			}, this);
			
		
			
			changesHTML += '</ul>';
			
			self.$el.append(changesHTML);
			
			if (scope == 'page') {
				self.renderAllChangesHighlighting(differenceCollection.models);
			}
		});
		
		return this;
	},
	renderRegistrations : function() {
		var titleHTML = '';
		titleHTML += '<h2>Registrations</h2>';
		
		this.$el.append(titleHTML);
		
		var differenceCollection = this.collection;
		
		differenceCollectionPromise = differenceCollection.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="track-changes-spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		$.when(differenceCollectionPromise).then(function() {
			self.$("div.track-changes-spinner-div").remove();

			var changesHTML = '';
			changesHTML += '<ul class="list-group">';
			
			_.each(differenceCollection.models, function(object) {
				changesHTML += '<li class="list-group-item">' +
					'<i>' + object.get('name') + '</i>' + 
				  	' registered at <i>' + object.get('createdAt') + '</i>' +
				  '</li>';
			}, this);
			
		
			
			changesHTML += '</ul>';
			
			self.$el.append(changesHTML);
		});
		
		return this;
	},
	renderRankings : function() {
		var titleHTML = '';
		titleHTML += '<h2>Rankings</h2>';
		
		this.$el.append(titleHTML);
		
		var differenceCollection = this.collection;
		
		differenceCollectionPromise = differenceCollection.fetch({reset: true});
		
		var self = this;
		
		var spinnerHTML = '';
		spinnerHTML += '<div class="track-changes-spinner-div">' +
	      '<span class="glyphicon glyphicon-refresh spin"></span>';
		spinnerHTML += '</div>';
		
		self.$el.append(spinnerHTML);
		
		$.when(differenceCollectionPromise).then(function() {
			self.$("div.track-changes-spinner-div").remove();

			var changesHTML = '';
			changesHTML += '<ul class="list-group">';
			
			_.each(differenceCollection.models, function(object) {
				changesHTML += '<li class="list-group-item">' +
					'<i>' + object.get('position') + '.</i>' + 
				  	' <i>' + object.get('user').name + '</i>' +
				  	' with <i>' + object.get('changes') + ' ' + (object.get('changes') > 1 ? 'changes' : 'change') +
				  '</li>';
			}, this);
			
			changesHTML += '</ul>';
			
			self.$el.append(changesHTML);
		});
		
		return this;
	}
});
var ConcreteInformationView = Backbone.View.extend({
	initialize : function() {
		this.template = _.template(tpl.get('layouts/concreteinformation'));
	},
	render : function() {
		var data = {"object": this.model};
		
		this.$el.html(this.template(data));
		
		return this;
	}
});
		
var ComposedBlockView = BaseView.extend({
	initialize : function() {
		//this.template = _.template(tpl.get('components/editor'));
	},
	events : {
		"change" : "changeValue"
	},
	changeValue : function(item) {
		if (typeof this.model.attributes.name === 'undefined') {
			this.model.set(item.target.id, item.target.value);
		} else {
			this.model.set('name', item.target.value);
		}
	},
	render : function() {
		this.$el.empty();
		
		if (typeof this.model !== 'undefined') {
			_.each(this.model.get('ComposedBlocks').models, function(object) {
				$(this.el).append(new ComposedBlockView({
					model : object
				}).render().el);
			}, this);
			
			_.each(this.model.get('TextBlocks').models, function(object) {
				$(this.el).append(new TextBlockView({
					model : object,
					parent : this
				}).render().el);
			}, this);
		}
		
		return this;
	}
});

var HypView = BaseView.extend({
	tagName : 'span',
	
	initialize : function(options) {
		this.parent = options.parent;
	},
	events : {
		"input" : "changeValue"
	},
	changeValue : function(item) {
		this.model.set('CONTENT', item.target.textContent);
	},
	render : function() {
		this.$el.empty();
		
		this.$el.html(this.model.get('CONTENT'));
		
		var lastString = this.parent.model.getLastString();
		
		var css = {
				'position' : 'absolute',	
				'width' : this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px',
				'height' : this.parent.model.get('HEIGHT') * editorOptions['zoomFactor'] + 'px',
				'left' : (parseInt(lastString.get('HPOS')) + parseInt(lastString.get('WIDTH')) - parseInt(this.parent.model.get('HPOS'))) * editorOptions['zoomFactor'] + 'px',
				'top' : '4px',
				
				'white-space' : 'nowrap',
				'display':'inline-block'
			};

		
		if (accessMode == "edit") {
			this.$el.attr('contentEditable', true);
		
			this.$el.append('<div style="position: absolute; top: 1px; left: 0px; outline: gainsboro solid 1px; width: 10px' + '; height: ' + lastString.get('HEIGHT') * editorOptions['zoomFactor'] + 'px' + '; z-index: -1;"></div>')
			
		} else {
			this.$el.attr('contentEditable', false);
		}
		
		
		css['font-family'] = this.parent.fontCSS['font-family'];
		css['font-size'] = this.parent.fontCSS['font-size'];
		
		this.$el.css(css);
		
		return this;
	}
});

var PageView = BaseView.extend({
	initialize : function() {
	},
	events : {
		"change" : "changeValue"
	},
	render : function() {
		this.$el.empty();
		
		var css = {
				'top'         		: '0px',
				'left'         		: '0px',
				'width'         	: this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px',
				'height'        	: this.model.get('HEIGHT') * editorOptions['zoomFactor'] + 'px',
				'border'			: '1px solid black'
			};
	
		$(this.el).append(new TopMarginView({
			model : this.model.get('TopMargin')
		}).render().el);
		
		$(this.el).append(new PrintSpaceView({
			model : this.model.get('PrintSpace')
		}).render().el);
		
		this.$el.css(css);
		
		return this;
	}
});

var PrintSpaceView = BaseView.extend({
	tagName : 'printspace',
	
	initialize : function() {
	},
	events : {
		"change" : "changeValue"
	},
	render : function() {
		$(this.el).empty();
		
		_.each(this.model.get('TextBlocks').models, function(object) {
			$(this.el).append(new TextBlockView({
				model : object,
				parent : this
			}).render().el);
		}, this);
		
		_.each(this.model.get('ComposedBlocks').models, function(object) {
			$(this.el).append(new ComposedBlockView({
				model : object,
				parent : this
			}).render().el);
		}, this);
		
		return this;
	}
});

var ScanImageView = BaseView.extend({
	initialize : function() {
	},
	events : {
		"change" : "changeValue"
	},
	render : function() {
		this.$el.empty();
		
		let imgWidth = this.model.get('width').replace('px', '') * editorOptions['zoomFactor'];
		let imgHeight = this.model.get('height').replace('px', '') * editorOptions['zoomFactor'];
		
		this.$el.css({
			'width'         	: imgWidth + 'px',
			'height'        	: imgHeight + 'px',
			});

		this.$el.html('<img src="' + "/kokos/data/ocr/images/" + this.model.get('filePath') + '" width="' + imgWidth + 'px' + '" height="' + imgHeight + 'px' + '"></img>');

		return this;
	}
});

var SPView = BaseView.extend({
	tagName : 'span',
	
	initialize : function() {
		//this.template = _.template(tpl.get('components/editor'));
	},
	events : {
		"change" : "changeValue"
	},
	changeValue : function(item) {
		if (typeof this.model.attributes.name === 'undefined') {
			this.model.set(item.target.id, item.target.value);
		} else {
			this.model.set('name', item.target.value);
		}
	},
	render : function() {
		this.$el.html(' ');

		this.$el.attr('VPOS', this.model.get('VPOS'));
		this.$el.attr('HPOS', this.model.get('HPOS'));
		this.$el.attr('WIDTH', this.model.get('WIDTH'));

		this.$el.css({
			'position'          : 'absolute',
			'width'         : this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px',
			'left'          : this.model.get('HPOS') * editorOptions['zoomFactor'] + 'px',
			'top'           : this.model.get('VPOS') * editorOptions['zoomFactor'] + 'px'
		    });
		
		return this;
	}
});

var StringView = BaseView.extend({
	tagName : 'span',
	
	activeContextMenuView : null,

	initialize : function(options) {
		this.parent = options.parent;
	},
	events : {
		"input" : "changeValue",
		"mouseover" : "mouseoverArea",
		"mouseout" : "mouseoutArea",
		"focus" : "focusArea",
		"dblclick" : "openContextMenu",
	},
	setActiveContextMenuView : function(newContextMenuView) {
		if (this.activeContextMenuView) {
			this.activeContextMenuView.clear();
		}

		this.activeContextMenuView = newContextMenuView;

		this.activeContextMenuView.render();
	},
	//TODO doublicate implemenation in tracker.js - consolidate
	mouseoverArea : function() {
		if (editorOptions['imageAvailable'] && editorOptions['facsimileVisibility']) {
			let xCoor = +this.model.get('HPOS');
			let yCoor = +this.model.get('VPOS');
			
			let hooverTop = 0 + (+yCoor * editorOptions['zoomFactor']);
			let hooverLeft = 0 + (+xCoor * editorOptions['zoomFactor']);
			
			$("#hooverCraft").css({
				'position' : 'absolute',	
				'width' : this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px',
				'height' : this.model.get('HEIGHT') * editorOptions['zoomFactor'] + 'px',
				'left' : hooverLeft + 'px',
				'top' : hooverTop + 'px',
				'backgroundColor' : 'rgba(255, 0, 0, 0.2)'
			});
			
			
		}
		
		if (this.hasFocus()) {
			this.$el.css({
				'cursor' : 'text'
			});
		} else {
			this.$el.css({
				'cursor' : 'pointer'
			});
		}
		
		let span_outline = this.$el.find('.span_outline')[0];
		
		if (span_outline) {
			span_outline.style.outline = 'grey solid 1px';
		}
	},
	mouseoutArea : function() {
		let span_outline = this.$el.find('.span_outline')[0];
		
		if (span_outline) span_outline.style.outline = 'gainsboro dotted 1px';
	},
	focusArea : function() {
		this.$el.css({
			'cursor' : 'text'
		});
	},
	openContextMenu : function(item) {
		if (accessMode == "edit") {
			modalView = new ContextModalView({
				model : this.model,
				parent : this
			});
			
			this.setActiveContextMenuView(modalView);
			
			$("#modal").append(this.activeContextMenuView.render().el);
			
			this.showContextMenu(item);
		}
	},
	showContextMenu : function(item) {
		this.activeContextMenuView.$('#contextMenu').modal('show');
		
		var css = {
				'height' : '100px',
			};
		
		this.activeContextMenuView.$('#contextMenu').find('#contextTextBlock').css(css);
		
		
		this.activeContextMenuView.renderTextLines();
		
	},
	changeValue : function(item) {
		this.model.set('CONTENT', item.target.textContent);
		
		//TODO splitting token
		/*if (item.target.textContent.indexOf(' ') >= 0) {
			let splitted = item.target.textContent.split(' ');
			
			let textlineString = this.model.collection;
			let textLine = this.model.relatedModel;
			this.render();
		} else {
			this.model.set('CONTENT', item.target.textContent);
		}*/
		
		
		//this.render();
	},
	render : function() {
		this.$el.empty();
		
		this.$el.html(this.model.get('CONTENT'));
		this.$el.attr('VPOS', this.model.get('VPOS'));
		this.$el.attr('HPOS', this.model.get('HPOS'));
		
		var css = {
				'position' : 'absolute',	
				'width' : this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px',
				'height' : (this.parent.model.get('HEIGHT') * editorOptions['zoomFactor'] + 3) + 'px',
				'left' : (this.model.get('HPOS') - this.parent.model.get('HPOS')) * editorOptions['zoomFactor'] + 'px',
				'top' : '4px',
				
				'white-space' : 'nowrap',
				'display':'inline-block'
			};
		
		if (accessMode == "edit") {
			this.$el.attr('contentEditable', true);
			
			this.$el.append('<div class="span_outline" style="position: absolute; top: 1px; left: 0px; outline: gainsboro dotted 1px; width: ' + this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px' + '; height: ' + (this.parent.model.get('HEIGHT') * editorOptions['zoomFactor'] + 1) + 'px' + '; z-index: -1;"></div>')
		} else {
			this.$el.attr('contentEditable', false);
		}
		
		css['font-family'] = this.parent.fontCSS['font-family'];
		css['font-size'] = this.parent.fontCSS['font-size'];
		
		this.$el.css(css);
		
		return this;
	}
});

var TextBlockView = BaseView.extend({
	tagName : 'textblock',
	
	initialize : function(options) {
		this.parent = options.parent;
	},
	render : function() {
		if (this.model.get('STYLEREFS')) {
			var fontId =  this.model.get('STYLEREFS').split(" ")[1];
			
			var textStyle = window['TextStyle'].findOrCreate({
				id : fontId
			});
		}
		
		
		this.$el.empty();

		if (typeof this.model !== 'undefined') {
			_.each(this.model.get('TextLines').models, function(object) {
				$(this.el).append(new TextLineView({
					model : object,
					parent : this
				}).render().el);
			}, this);
		}
		
		return this;
	}
});

var TextLineView = BaseView.extend({
	tagName : 'textline',
	
	initialize : function(options) {
		this.parent = options.parent;
		
		this.fontCSS = this.model.getFontCSS();
	},
	render : function() {
		var view = ALTOEditorView;
		
		this.$el.empty();
		
		if (this.model.get('STYLEREFS')) {
			var fontId =  this.model.get('STYLEREFS').split(" ")[1];
			
			
			var textStyle = window['TextStyle'].findOrCreate({
				id : fontId
			});
			
			var css = {
					'position'          : 'absolute',
					'width'         : this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px',
					'height'        : 1 * editorOptions['zoomFactor'] + 'px',
					'left'          : this.model.get('HPOS') * editorOptions['zoomFactor'] + 'px',
					'top'           : this.model.get('VPOS') * editorOptions['zoomFactor'] + 'px'
				};
		} else {
			var css = {
					'position' : 'absolute',	
					'width' : this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px',
					'height' : 0 * editorOptions['zoomFactor'] + 'px',
					'left' : this.model.get('HPOS') * editorOptions['zoomFactor'] + 'px',
					'top' : this.model.get('VPOS') * editorOptions['zoomFactor'] + 'px'
				};
		}
		
		_.each(this.model.get('Strings').models, function(object) {
			if (object.get('SUBS_TYPE') === 'HypPart1') {
				object.set('CONTENT', object.get('CONTENT'));
				var stringView = new StringView({
					model : object,
					parent : this
				});
			
				$(this.el).append(stringView.render().el);
				
				var hypView = new HypView({
					model : new HYP({"CONTENT": "-"}),
					parent : this
				});
				
				$(this.el).append(hypView.render().el);
			} else {
				var stringView = new StringView({
					model : object,
					parent : this
				});
			
				$(this.el).append(stringView.render().el);
			}
		}, this);
		
		_.each(this.model.get('SPs').models, function(object) {
			$(this.el).append(new SPView({
				model : object
			}).render().el);
		}, this);
		
		this.$el.css(css);
		
		return this;
	}
});

var TopMarginView = BaseView.extend({
	tagName : 'topmargin',
	
	initialize : function() {
	},
	events : {
		"change" : "changeValue"
	},
	render : function() {
		$(this.el).empty();
		
		/*var css = {
				'position' : 'relative',	
				'width' : this.model.get('WIDTH') * editorOptions['zoomFactor'] + 'px',
				'height' : this.model.get('HEIGHT') * 1.3 * editorOptions['zoomFactor'] + 'px',
				'left' : this.model.get('HPOS') * editorOptions['zoomFactor'] + 'px',
				'top' : this.model.get('VPOS') * editorOptions['zoomFactor'] + 'px',
				'white-space' : 'nowrap'
			};
		*/
		if (this.model) {
			if (this.model.get('TextBlocks')) {
				_.each(this.model.get('TextBlocks').models, function(object) {
					$(this.el).append(new TextBlockView({
						model : object
					}).render().el);
					
				}, this);
			}
			
			if (this.model.get('ComposedBlocks')) {
				_.each(this.model.get('ComposedBlocks').models, function(object) {
					$(this.el).append(new ComposedBlockView({
						model : object
					}).render().el);
				}, this);
			}
		}
		
		//this.$el.css(css);
		
		return this;
	}
});

var EntityImportView = BaseView.extend({

    tagName:"div", // Not required since 'div' is the default if no el or tagName specified

    initialize:function () {
        this.template = _.template(tpl.get('layouts/entityimport'));
        
        this.fieldViews = [];
		
		fieldView = this.createFileUploadFieldView("entitiesFile");
		if (fieldView) {
			this.fieldViews.push(fieldView);
		}
    },

    events:{
        "click #btn_parse":"parseResource"
    },
    createFileUploadFieldView : function(field) {
		var value_type = "file";
		
		if (value_type === "file") {
			fieldView = new FileUploadView();
			fieldView.field = field;
			fieldView.model = this.model;
			
			return fieldView;
		}
		
		return false;
	},
    render: function () {
		this.$el.html(this.template());
		
		this.renderTitle(this.model.get('name') + " Entities Import");
		
		this.$("#field-container").append(this.fieldViews[0].render().el);
		this.fieldViews[0].delegateEvents();
		
        return this;
    }
});
window.EntityListView = BaseView.extend({
	initialize : function(options) {
		this.options = options;
		
		this.template = _.template(tpl.get('layouts/entitylist'));
		
		this.tableView		= new BackGridTableView({collection : this.collection, OntologyClass : this.options.OntologyClass});
		this.tableView.columns.push({
			name : "actions", // The key of the model attribute
			label : "Actions", // The name to display in the header
			sortable: false,
			editable : false,
			cell : ActionsCell.extend({
				orderSeparator : '',
				actions : ["delete"]
			})
		})
		this.buttonView 	= new ButtonView({id: "btn_add_entity"});
	},
	events : {
		"click #btn_add_entity" : "addEntity"
	},
	addEntity : function(item) {
    	var url = window.location.href;

    	window.location = url + '/new';
	},
	render : function() {
		this.$el.html(this.template());
		
		$("#title").html(getPlural(this.options.objectName));
		
	    this.assign({
			'#table'       		: this.tableView
		});
		
	    this.$("#sidebar").append(this.buttonView.render().el);
	    this.buttonView.delegateEvents();
		
	    return this;
	}
});
window.ObjectListView = BaseView.extend({
	initialize : function(options) {
		this.options = options;
		
		this.template = _.template(tpl.get('layouts/objectlist'));
		
		this.tableView		= new BackGridTableView({collection : this.collection});
		this.tableView.columns.push({
			name : "actions", // The key of the model attribute
			label : "Actions", // The name to display in the header
			sortable: false,
			editable : false,
			cell : ActionsCell.extend({
				orderSeparator : '',
				actions : ["delete"]
			})
		})
		this.buttonView 	= new ButtonView({id: "btn_add"});
	},
	events : {
		"click #btn_add" : "addnewObject"
	},
	addnewObject : function(item) {
		app.navigate('new', true);
		
		return false;
	},
	render : function() {
		this.$el.html(this.template());
		
		this.renderTitle();
 		
	    this.assign({
			'#table'       		: this.tableView
		});
		
	    this.$("#sidebar").append(this.buttonView.render().el);
	    this.buttonView.delegateEvents();
		if (!Cookie.get("UserID") && Cookie.get("logged") == 0) {
			
	    }
		
	    return this;
	}
});
var OntologyInformationView = Backbone.View.extend({
	initialize : function() {
		this.template = _.template(tpl.get('layouts/ontologyinformation'));
	},
	render : function() {
		var data = {"ontologyClass": this.model};
		
		this.$el.html(this.template(data));
		
		return this;
	}
});
		
var WidgetView = SingleObjectView.extend({
	initialize : function() {
		SingleObjectView.__super__.initialize.apply(this, arguments);
	},
	events : {
	},
	render : function() {
		var data = {"hasFieldGroups": this.hasFieldGroups};

		this.$el.html(this.template(data));
		
		this.renderTitle(this.model.get('OntologyClass').get('name') + ": " + this.model.getNameProperty().get('name'));
 		
		if (this.hasFieldGroups) {
			this.renderFieldGroups();			
		} else {
			for (var i = 0; i < this.fieldViews.length; i++) {
				this.$("#field-container").append(this.fieldViews[i].render().el);
				this.fieldViews[i].delegateEvents();
			}
		}
		
		this.renderButtons();
		
		return this;
	}
});
		